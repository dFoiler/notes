% !TEX root = ../notes.tex

\documentclass[../notes.tex]{subfiles}

\begin{document}

\section{April 10}

There are many cookies to be eaten. The homework is now due on Friday.

\subsection{Flatness for Rings}
Today we're talking about flat morphisms. Our goal today is to prove flat base-change. The point here is that the fibers are supposed to communicate with each other. Anyway, our definition comes from commutative algebra.
\begin{definition}[flat]
	Fix a ring $A$. Then an $A$-module $M$ is \textit{flat} if and only if the functor $M\otimes_A-\colon\mathrm{Mod}_A\to\mathrm{Mod}_A$ is exact.
\end{definition}
\begin{remark}
	Because $M\otimes_A-$ is already right-exact automatically, the functor $M\otimes_A-$ is flat if and only if injections $N'\into N$ remain injections $M\otimes_AN'\into M\otimes_AN$.
\end{remark}
\begin{remark}
	There is also a notion of ``faithfully flat'' which means that $M\otimes_A-$ also ``reflects'' exactness. Namely, we require that a sequence
	\[0\to N'\to N\to N''\to0\]
	is exact if and only if
	\[0\to M\otimes_AN'\to M\otimes_AN\to M\otimes_AN''\to0\]
	is exact.
\end{remark}
Here are some properties of flat morphisms.
\begin{lemma} \label{lem:flatness-by-ideals}
	Fix a ring $A$. Then an $A$-module $M$ is flat if and only if the morphism $I\otimes_AM\to M$ is injective for any finitely generated $A$-ideal $I$. In other words, we require the natural map $I\otimes_AM\to IM$ to be an isomorphism.
\end{lemma}
\begin{proof}
	The forward direction simply applies flatness to the injection $I\into A$. The backward direction is just a bunch of reductions; we omit the details.
\end{proof}
\begin{lemma}[Base extension] \label{lem:flat-base-extension}
	Fix a $B$-algebra $A$. If an $A$-module $M$ is flat, then $M\otimes_AB$ is flat over $B$.
\end{lemma}
\begin{proof}
	Fix an injection $N'\into N$ of $B$-modules. Then we have the commutative diagram
	% https://q.uiver.app/?q=WzAsNCxbMCwwLCIoTVxcb3RpbWVzX0FCKVxcb3RpbWVzX0IgTiciXSxbMSwwLCIoTVxcb3RpbWVzX0FCKVxcb3RpbWVzIE4iXSxbMCwxLCJNXFxvdGltZXNfQSBOJyJdLFsxLDEsIk1cXG90aW1lc19BTiJdLFswLDFdLFsyLDNdLFswLDIsIlxcc2ltZXEiXSxbMSwzLCJcXHNpbWVxIl1d&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
	\[\begin{tikzcd}
		{(M\otimes_AB)\otimes_B N'} & {(M\otimes_AB)\otimes N} \\
		{M\otimes_A N'} & {M\otimes_AN}
		\arrow[from=1-1, to=1-2]
		\arrow[from=2-1, to=2-2]
		\arrow["\simeq", from=1-1, to=2-1]
		\arrow["\simeq", from=1-2, to=2-2]
	\end{tikzcd}\]
	whose vertical arrows are isomorphisms. The bottom row is injective because $M$ is flat over $A$, so the top row is also injective.
\end{proof}
\begin{lemma}[Transitivity] \label{lem:flat-trans}
	Fix a flat $A$-algebra $B$. If $M$ is flat as a $B$-module, then it is also flat as an $A$-module.
\end{lemma}
\begin{proof}
	As usual, fix an injection of $A$-modules $N'\into N$. Then the map $N'\otimes_AB\to N\otimes_AB$ is injective because $B$ is a flat $A$-algebra, so
	\[N'\otimes_AB\otimes_BM\to N\otimes_AB\otimes_BM\]
	is injective because $M$ is flat over $B$. But the above map is isomorphic to $N'\otimes_AM\to N\otimes_AM$, so we are done.
\end{proof}
\begin{lemma} \label{lem:flat-is-local}
	Fix a ring $A$. Then an $A$-module $M$ is flat over $A$ if and only if $M_\mf p$ is flat over $A_\mf p$ for each $\mf p\in\Spec A$.
\end{lemma}
\begin{proof}
	The forward direction is from \Cref{lem:flat-base-extension} because $M_\mf p\simeq M\otimes_AA_\mf p$. For the backward direction, this is the statement that exactness can be checked on the level of stalks combined with the natural isomorphism $M_\mf p\otimes_{A_\mf p}N_\mf p\simeq(M\otimes_AN)_\mf p$.
\end{proof}
\begin{lemma}
	Fix a ring $A$. For any multiplicatively closed subset $S\subseteq A$, the $A$-algebra $A\left[S^{-1}\right]$ is flat.
\end{lemma}
\begin{proof}
	Fix an inclusion $N'\into N$, and we want to show that the map $N'\left[S^{-1}\right]\to N\left[S^{-1}\right]$ is still injective. But given $\frac{x'}s$ going to $0$ in $N\left[S^{-1}\right]$, we see that $s'x'=0$ for some $s'\in 0$, but this means that $\frac{x'}{s'}=0$ back in $N'\left[S^{-1}\right]$.
\end{proof}
\begin{lemma}
	Fix an exact sequence
	\[0\to M'\to M\to M''\to0\]
	of $A$-modules. If $M'$ and $M''$ is flat, them $M$ is flat. Also, if $M$ and $M''$ are flat, then $M'$ is flat.
\end{lemma}
\begin{proof}
	We use \Cref{lem:flatness-by-ideals}. Fix an $A$-ideal $I$. Then we have the following commutative diagram.
	% https://q.uiver.app/?q=WzAsOSxbMCwxLCIwIl0sWzEsMSwiTSciXSxbMiwxLCJNIl0sWzMsMSwiTScnIl0sWzQsMSwiMCJdLFsxLDAsIklcXG90aW1lc19BIE0nIl0sWzIsMCwiSVxcb3RpbWVzX0FNIl0sWzMsMCwiSVxcb3RpbWVzX0FNJyciXSxbNCwwLCIwIl0sWzAsMV0sWzEsMl0sWzIsM10sWzMsNF0sWzUsMV0sWzYsMl0sWzcsM10sWzUsNl0sWzYsN10sWzcsOF1d&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
	\[\begin{tikzcd}
		& {I\otimes_A M'} & {I\otimes_AM} & {I\otimes_AM''} & 0 \\
		0 & {M'} & M & {M''} & 0
		\arrow[from=2-1, to=2-2]
		\arrow[from=2-2, to=2-3]
		\arrow[from=2-3, to=2-4]
		\arrow[from=2-4, to=2-5]
		\arrow[from=1-2, to=2-2]
		\arrow[from=1-3, to=2-3]
		\arrow[from=1-4, to=2-4]
		\arrow[from=1-2, to=1-3]
		\arrow[from=1-3, to=1-4]
		\arrow[from=1-4, to=1-5]
	\end{tikzcd}\]
	For the first claim, we simply note that the left and right vertical arrows are injective, so the middle vertical arrow is injective, which completes the proof. For the second claim, I think it follows directly from the $\op{Tor}$ characterization of flatness.
\end{proof}
\begin{lemma} \label{lem:flatness-locally}
	Fix a Noetherian local ring $A$. If $M$ is a finitely generated flat $A$-module, then $M$ is free.
\end{lemma}
\begin{proof}
	Omitted.
\end{proof}
Let's see some examples.
\begin{example}
	For any $A$-ideal $I$, the completion
	\[\widehat A\coloneqq\lim_nA/I^n\]
	is flat. We will not show this; it is mildly technical.
\end{example}
\begin{example}
	Fix a principal ideal domain $A$. Then we claim that $M$ is flat if and only if $M$ is torsion-free. Indeed, by \Cref{lem:flatness-by-ideals}, we are asking for the map $(a)\otimes_AM\to M$ to be injective for any $a\in A$, which is equivalent to $a$ not being a zero-divisor on $M$. Looping over all $a\in A$ says that this is equivalent to $M$ being torsion-free.
\end{example}

\subsection{Flatness for Sheaves}
We now translate our lemmas above to algebraic geometry.
\begin{definition}[flat]
	Let $f\colon X\to Y$ be a morphism of schemes. An $\mathcal O_X$-module $\mc F$ is \textit{flat at a point $x\in X$} if and only if the stalk $\mc F_x$ is flat as an $\mathcal O_{Y,f(x)}$-module. Then $\mc F$ is \textit{flat} if and only if it is flat at each point $x\in X$. Lastly, $f$ is \textit{flat} if and only if $\OO_X$ is flat.
\end{definition}
\begin{remark}
	If $\mc F$ is a quasicoherent sheaf over $X$, then we may check flatness on affine open subschemes by \Cref{lem:flat-is-local}. Explicitly, given an $A$-algebra $B$ and a $B$-module $M$, then $M$ is flat over $A$ if and only if $\widetilde M$ is flat over $\Spec A$.
\end{remark}
Here are the usual checks.
\begin{lemma}
	An open embedding $f\colon X\to Y$ is flat.
\end{lemma}
\begin{proof}
	Stalks don't change in open embeddings, so there is nothing to say.
\end{proof}
\begin{lemma}[Base change]
	Fix a morphism of schemes $f\colon X\to Y$, and let $g\colon X'\to X$ be some flat morphism. If $\mc F$ is a flat $\OO_X$-module, then $g^*\mc F$ is flat over $X'$.
\end{lemma}
\begin{proof}
	Check at stalks.
\end{proof}
\begin{lemma}[Transitivity]
	Fix scheme morphisms $f\colon X\to Y$ and $g\colon Y\to Z$. Given an $\mathcal O_X$-module $\mc F$ flat over $Y$, then $\mc F$ is also flat over $Z$.
\end{lemma}
\begin{proof}
	Check at stalks and use transitivity.
\end{proof}
\begin{lemma}
	Fix a Noetherian scheme $X$. Then a coherent sheaf $\mc F$ is flat over $X$ if and only if $\mc F$ is locally free.
\end{lemma}
\begin{proof}
	Check at stalks and use \Cref{lem:flatness-locally}.
\end{proof}

\subsection{Flat Base-Change}
Anyway, here is our main result.
\begin{theorem} \label{thm:flat-base-change}
	Fix a flat finite-type separated morphism $f\colon X\to Y$ of Noetherian schemes. Further, let $u\colon Y'\to Y$ be a flat morphism of Noetherian schemes, and let $v\colon X\times_YY'\to X$ be the base-change of $u$ and $g\colon X\times_YY'\to Y$ be the base-change of $g$. Given a quasicoherent sheaf $\mc F$ on $X$, we have natural isomorphisms
	\[u^*R^if_*\mc F\to R^ig_*v^*\mc F.\]
\end{theorem}
\begin{proof}
	Here is our pullback square.
	% https://q.uiver.app/?q=WzAsNCxbMSwxLCJZIl0sWzAsMSwiWSciXSxbMCwwLCJYJyJdLFsxLDAsIlgiXSxbMiwzLCJ2Il0sWzMsMCwiZiJdLFsxLDAsInUiXSxbMiwxLCJnIiwyXV0=&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
	\[\begin{tikzcd}
		{X'} & X \\
		{Y'} & Y
		\arrow["v", from=1-1, to=1-2]
		\arrow["f", from=1-2, to=2-2]
		\arrow["u", from=2-1, to=2-2]
		\arrow["g"', from=1-1, to=2-1]
	\end{tikzcd}\]
	Everything is local on $Y$ and $Y'$, so we may replace those with affine open subschemes, where the statement reduces to a statement about bona fide cohomology. The statement essentially reduces to showing an isomorphism
	\[H^i(X,\mc F)\otimes_AA'\cong H^i(X\times_YY',v^*\mc F).\]
	Now, using \v Cech cohomology via to compute cohomology on $X\times_YY'$, we want some equivalence of \v Cech complexes, which we can compute directly.
\end{proof}

\end{document}