%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% LICENSING
% this style file is licensed under the BOOST software license 1.0
% basically, do whatever you want with this
% but please include this license information wherever you copy it

% Boost Software License - Version 1.0 - August 17th, 2003
%
% Copyright (c) 2020 Nir Elber
%
% Permission is hereby granted, free of charge, to any person or organization
% obtaining a copy of the software and accompanying documentation covered by
% this license (the "Software") to use, reproduce, display, distribute,
% execute, and transmit the Software, and to prepare derivative works of the
% Software, and to permit third-parties to whom the Software is furnished to
% do so, all subject to the following:
%
% The copyright notices in the Software and this entire statement, including
% the above license grant, this restriction and the following disclaimer,
% must be included in all copies of the Software, in whole or in part, and
% all derivative works of the Software, unless such copies or derivative
% works are solely in the form of machine-executable object code generated by
% a source language processor.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
% FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
% SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
% FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
% ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
% DEALINGS IN THE SOFTWARE.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /LICENSING

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% HOW TO USE
% some notes on using this file:
% - this file is constantly a work-in-progress; it changes frequently
% - this style file is actually split into multiple!
%   if you don't want to deal with the splitting, set the following to false
\newif\ifnirfiles
\nirfilestrue
%   otherwise, please also include sty/fitch.sty and sty/quiver.sy
%   to make the includes work, import as `\inputfrom{your/directory}{nir}`
% - this file is also split into headers that mostly commute
%   feel free to delete and move them around as you see fit
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /HOW TO USE

% LTeX: enabled=false

\usepackage[margin=1in, marginparwidth=2cm]{geometry}
\usepackage[table,dvipsnames]{xcolor}
\usepackage{amsmath,amssymb,amsthm}
\usepackage{amsfonts}
\usepackage{asymptote}
\usepackage{cancel}
\usepackage{enumitem}
\usepackage{etoolbox}
\usepackage{footnotebackref}
\usepackage{graphicx}
\usepackage{mathdots}
\usepackage{mathtools} % \todo{deal with f : X -> Y to use \colon}
\usepackage{pgffor}
\usepackage{subfiles}
\usepackage{stmaryrd}
\usepackage{textcase}
\usepackage{tikz-cd}
\usepackage{tocbibind}
\usepackage{todonotes}
\usepackage{xparse}
\usepackage{xr}

\ifnirfiles
	\usepackage{sty/fitch}
	\usepackage{sty/quiver}
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SET-UP
\renewcommand{\familydefault}{\sfdefault}
\usepackage{cabin}
\usepackage[default]{cantarell}

\usepackage{fancyhdr}
\renewcommand{\headrulewidth}{0pt}
\fancypagestyle{contentpage}{%
	\lhead{\textit{\rightmark}}
	\cfoot{\thepage}
}

% link color stolen from wikipedia's dark blue
\definecolor{wikipediadarkblue}{rgb}{0.023, 0.270, 0.676}
\providecommand{\nirpdftitle}{notes}
\hypersetup{
	colorlinks,
	citecolor=black,
	filecolor=black,
	linkcolor=wikipediadarkblue,
	urlcolor=wikipediadarkblue,
	pdftitle={\nirpdftitle},
	pdfauthor={Nir Elber}
}
\usepackage{hyperref}

% Labeling equations; I don't know where else to put this
\def\equationautorefname#1#2\null{%
	(#2\null)%
}

% Sometimes I want to see the labels
\newif\ifnirdebug
\nirdebugfalse

\ifnirdebug
	\usepackage{showkeys}
\fi
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /SET-UP

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% INDEX
\usepackage{imakeidx}
\makeindex[intoc, title=List of Definitions]
% thank you https://tex.stackexchange.com/a/299353/261927
% we are going to label each index entry with a counter
\newcounter{indexcounterlabel}
\setcounter{indexcounterlabel}{0}
\newcommand{\nirindexlabel}[1]{\label{indexentry:#1}}
\newcommand{\nirindex}[1]
{%
	\stepcounter{indexcounterlabel}%
	\nirindexlabel{\theindexcounterlabel}%
	% this command will do the labeling
	\index{#1|hyperref[indexentry:\theindexcounterlabel]}%
}
\newcommand{\nirprintindex}{\newpage\toctrue\printindex\tocfalse}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /INDEX

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% TITLING
\usepackage{titlesec}
\newif\iftoc

% Formatting of part
\titleformat
	{\part} % command
	[display] % shape
	{\cabin\bfseries\LARGE\scshape} % format
	{\centering\LARGE Part \thepart} % label
	{10mm} % 
	{\centering\Huge} % before-code
	[
		\thispagestyle{empty}
	] % after-code
\titlespacing*{\part}{0mm}{30mm}{30mm}
\titleclass{\part}{top}
\newcommand\partbreak{\clearpage}

% Formatting of chapter
\titleformat
	{\chapter} % command
	[display] % shape
	{\cabin} % format
	{} % label
	{2in} % 
	{
		% \rule{\textwidth}{1pt}
		% \vspace{1ex}
		\raggedleft
		% \\\vspace{-22pt}
		\iftoc
			\vspace{2in}
		\else
			{\LARGE\textsc{Theme}~{\cantarell\thechapter}}\\ % I like the other numbers ...
		\fi
		\Huge\scshape\bfseries
	} % before-code
	[
		\vspace{-18pt}%
		\rule{\textwidth}{0.1pt}
		\vspace{0.0in}
	] % after-code
\titlespacing{\chapter}
	{0pt}
	{
		\iftoc
			-103pt+1in
		\else
			-127pt+1in
		\fi
	}
	{0pt}

% Formatting of parts
\titleformat
	{\section}
	{\Large\bfseries}
	{\thesection}
	{1em}
	{}
	[\label{sec:\csname thesection\endcsname}]
\setcounter{tocdepth}{1}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /TITLING

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% EPIGRAPH
\usepackage{epigraph}
% Thank you https://tex.stackexchange.com/a/193189
\renewcommand\textflush{flushright}

\usepackage{etoolbox}
\makeatletter
\newlength\epitextskip
\pretocmd{\@epitext}{\em}{}{}
\apptocmd{\@epitext}{\em}{}{}
\patchcmd{\epigraph}
	{\@epitext{#1}\\}
	{\vspace{-0.3in+20pt}\@epitext{#1}\\[\epitextskip]}
	{}
	{}
\makeatother

\setlength\epigraphrule{0pt}
\setlength\epitextskip{2ex}
\setlength\epigraphwidth{.6\textwidth}
\setlength\afterepigraphskip{30pt}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /EPIGRAPH

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% CONVENIENCE
% Various black-board things
\renewcommand{\AA}{\mathbb A}
\newcommand{\RR}{\mathbb R}
\newcommand{\ZZ}{\mathbb Z}
\newcommand{\NN}{\mathbb N}
\newcommand{\QQ}{\mathbb Q}
\newcommand{\CC}{\mathbb C}
\newcommand{\FF}{\mathbb F}
\newcommand{\OO}{\mathcal O}
\newcommand{\PP}{\mathbb P}
\newcommand{\CP}{\mathbb{CP}}

\newcommand{\e}{\varepsilon}
\newcommand{\ball}[2]{(#1-#2,\,#1+#2)}

\newcommand{\floor}[1]{\left\lfloor{#1}\right\rfloor}
\newcommand{\ceil}[1]{\left\lceil{#1}\right\rceil}
\newcommand{\norm}[1]{\left\lVert{#1}\right\rVert}
\newcommand{\diff}{\operatorname{diff }}
\newcommand{\disc}{\operatorname{disc }}
\newcommand{\ord}{\operatorname{ord}}
\newcommand{\lcm}{\operatorname{lcm}}
\newcommand{\del}{\partial}
\newcommand{\emp}{\varnothing}
\newcommand{\divides}{\,|\,}
\newcommand{\op}[1]{\operatorname{#1}}
\newcommand{\mf}[1]{\mathfrak{#1}}
\newcommand{\mc}[1]{\mathcal{#1}}

\newcommand{\bb}[1]{\left\llbracket{#1}\right\rrbracket}

% Algebra
\newcommand{\coker}{\operatorname{coker}} % why isn't this a thing?!
\newcommand{\codim}{\operatorname{codim}}
\newcommand{\id}{\operatorname{id}}
\newcommand{\tr}{\operatorname{tr}}
\newcommand{\im}{\operatorname{im}}
\newcommand{\sgn}{\operatorname{sgn}}
\newcommand{\rad}{\operatorname{rad}}
\newcommand{\into}{\hookrightarrow}
\newcommand{\onto}{\twoheadrightarrow}
\newcommand{\from}{\leftarrow}
\newcommand{\eq}{\operatorname{eq}}

\newcommand{\limit}{\varprojlim}
\newcommand{\colimit}{\varinjlim}
\DeclareMathOperator*{\colim}{colim}
\newcommand{\opp}{^\mathrm{op}}

% Type theory
\newcommand{\refl}{\op{refl}}
\newcommand{\UU}{\mathcal{U}}

% Complex Analysis
\renewcommand{\Re}{\operatorname{Re}}
\renewcommand{\Im}{\operatorname{Im}}

% Category theory
\DeclareFontFamily{U}{dmjhira}{}
\DeclareFontShape{U}{dmjhira}{m}{n}{ <-> dmjhira }{}
\DeclareRobustCommand{\yo}{\text{\usefont{U}{dmjhira}{m}{n}\symbol{"48}}}
\newcommand{\adjoint}{\dashv}

% Logic
\newcommand{\lif}{\rightarrow}
\newcommand{\liff}{\leftrightarrow}
\newcommand{\bigland}{\bigwedge}
\newcommand{\biglor}{\bigvee}
\renewcommand{\models}{\vDash}
\newcommand{\nmodels}{\nvDash}

% Colons
\AtBeginDocument{%
	\mathchardef\ordinarycolon=\mathcode`:
	\mathcode`:="8000
}
\makeatletter
\newcommand{\coloncheck}{\@ifnextchar={\coloneqq\@gobble}{\ordinarycolon}}
\makeatother
\begingroup\lccode`~=`: \lowercase{\endgroup\let~}\coloncheck

\newenvironment{solution}{
\begin{proof}[Solution]}{\end{proof}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /CONVENIENCE

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DANGERS
% Thank you https://tex.stackexchange.com/a/604048
\newcommand{\nirideasymbol}{%
	\begin{tikzpicture}[baseline=(x.base)]
		\draw[rounded corners=.01em] (-.05em,-1.07em)rectangle(.05em,.78em);
		\draw[fill=white,rounded corners=1.3] (0,.75em)--(.75em,0)--(0,-.75em)--(-.75em,0)--cycle;
		\draw[line width=0.2mm, line cap=round](-.4em,-1.07em)--(.4em,-1.07em);
		\node(x) at (0,0em) {};
		\node at (0,0em) {{\cabin\textbf{!}}};
	\end{tikzpicture}%
}
\newcommand{\nirwarnsymbol}{%
	\begin{tikzpicture}[baseline=(x.base)]
		\draw[rounded corners=.01em] (-.05em,-1.07em)rectangle(.05em,.78em);
		\draw[fill=white,rounded corners=1.3] (0,.75em)--(.75em,0)--(0,-.75em)--(-.75em,0)--cycle;
		\draw[line width=0.2mm, line cap=round](-.4em,-1.07em)--(.4em,-1.07em);
		\node(x) at (0,0em) {};
		% Thank you https://tex.stackexchange.com/a/262510
		\draw[
			line cap=but,
			line join=round,
			x=.5em,
			line width=0.5mm,
			y=1*(height("Z")-\pgflinewidth)*(1-sin(10)),
			rotate=-10,
			rounded corners=1.5pt,
		](-0.57, 0.57) -- (0.57, 0.57) -- (-0.57, -0.57) -- (0.57, -0.57);
	\end{tikzpicture}%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /DANGERS

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% MARGINS
\usepackage{marginnote}
% Thank you https://tex.stackexchange.com/a/472882
% Makes marginnotes always appear on the left, apparently
%
\makeatletter
\long\def\@mn@@@marginnote[#1]#2[#3]{%
	\begingroup
		\ifmmode\mn@strut\let\@tempa\mn@vadjust\else
			\if@inlabel\leavevmode\fi
			\ifhmode\mn@strut\let\@tempa\mn@vadjust\else\let\@tempa\mn@vlap\fi
		\fi
		\@tempa{%
			\vbox to\z@{%
				\vss
				\@mn@margintest
				\if@reversemargin\if@tempswa
						\@tempswafalse
					\else
						\@tempswatrue
				\fi\fi

					\llap{%
						\vbox to\z@{\kern\marginnotevadjust\kern #3
							\vbox to\z@{%
								\hsize\marginparwidth
								\linewidth\hsize
								\kern-\parskip
								%\mn@parboxrestore
								\marginfont\raggedleftmarginnote\strut\hspace{\z@}%
								\ignorespaces#1\endgraf
								\vss
							}%
							\vss
						}%
						\if@mn@verbose
							\PackageInfo{marginnote}{xpos seems to be \@mn@currxpos}%
						\fi
						\begingroup
							\ifx\@mn@currxpos\relax\else\ifx\@mn@currpos\@empty\else
									\kern\@mn@currxpos
							\fi\fi
							\ifx\@mn@currpage\relax
								\let\@mn@currpage\@ne
							\fi
							\if@twoside\ifodd\@mn@currpage\relax
									\kern-\oddsidemargin
								\else
									\kern-\evensidemargin
								\fi
							\else
								\kern-\oddsidemargin
							\fi
							\kern-1in
						\endgroup
						\kern\marginparsep
					}%
			}%
		}%
	\endgroup
}
\makeatother
%
% Mostly for todonotes
\renewcommand{\marginpar}{\marginnote}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /MARGINS

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% LISTS
% Putting these into an environment decreases clicking
\newlist{listalph}{enumerate}{1}
\setlist[listalph,1]{label=(\alph*)}
\newlist{listroman}{enumerate}{1}
\setlist[listroman,1]{label=(\roman*)}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /LISTS

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% LISTINGS
\usepackage{courier}
\usepackage{listings}
\lstset{basicstyle=\ttfamily,breaklines=true}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /LISTINGS

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% THM BOXES
% See http://texdoc.net/texmf-dist/doc/latex/thmtools/thmtools.pdf
\renewcommand{\qedsymbol}{$\blacksquare$}
\usepackage{thmtools,thm-restate}

\usepackage[framemethod=TikZ]{mdframed}
% Fixing mdframed skip below
% See https://tex.stackexchange.com/a/292090/143086
\usepackage[framemethod=TikZ]{mdframed}
\usepackage{xpatch}
\makeatletter
\xpatchcmd{\endmdframed}
	{\aftergroup\endmdf@trivlist\color@endgroup}
	{\endmdf@trivlist\color@endgroup\@doendpe}
	{}{}
\makeatother

\definecolor{nirlightblue}{HTML}{f7f7ff}
\definecolor{nirdarkblue}{HTML}{1d1dbf}
\declaretheoremstyle[
	mdframed={
		backgroundcolor=nirlightblue,
		linecolor=nirdarkblue,
		rightline=false,
		topline=false,
		bottomline=false,
		linewidth=2pt,
		innertopmargin=5pt,
		innerbottommargin=8pt,
		innerleftmargin=8pt,
		leftmargin=-2pt,
		skipbelow=2pt,
		nobreak
	},
	headfont=\normalfont\bfseries\color{nirdarkblue}
]{nirbluebox}
% I want to label things by chapter, but not all things I write have chapter
\ifx\thechapter\undefined
	\declaretheorem[style=nirbluebox,name=Theorem]{thm}
\else
	\declaretheorem[style=nirbluebox,name=Theorem,within=chapter]{thm}
\fi
\declaretheorem[style=nirbluebox,name=Theorem,sibling=thm]{theorem}
\declaretheorem[style=nirbluebox,name=Proposition,sibling=thm]{prop}
\declaretheorem[style=nirbluebox,name=Proposition,sibling=thm]{proposition}
\declaretheorem[style=nirbluebox,name=Problem,numberwithin=section]{prob}
\declaretheorem[style=nirbluebox,name=Lemma,sibling=thm]{lem}
\declaretheorem[style=nirbluebox,name=Lemma,sibling=thm]{lemma}
\declaretheorem[style=nirbluebox,name=Corollary,sibling=thm]{cor}
\declaretheorem[style=nirbluebox,name=Corollary,sibling=thm]{corollary}

\definecolor{nirlightred}{RGB}{250, 220, 220}
\definecolor{nirdarkred}{HTML}{f40000}
\declaretheoremstyle[
	mdframed={
		backgroundcolor=nirlightred,
		linecolor=nirdarkred,
		rightline=false,
		topline=false,
		bottomline=false,
		linewidth=2pt,
		innertopmargin=5pt,
		innerbottommargin=8pt,
		innerleftmargin=8pt,
		leftmargin=-2pt,
		skipbelow=2pt,
		nobreak
	},
	headfont=\normalfont\bfseries\color{nirdarkred}
]{nirredbox}
\declaretheorem[style=nirredbox,name=Conjecture,sibling=thm]{conj}
\declaretheorem[style=nirredbox,name=Question,sibling=thm]{ques}
\declaretheorem[style=nirredbox,name=Convention,sibling=thm]{conv}
\declaretheorem[style=nirredbox,name=Convention,sibling=thm]{convention}

\makeatletter
\declaretheorem[
	style=nirredbox,
	name=Idea,
	sibling=thm,
	% without phantom{}, the first item in a list gets misformatted \todo{implement https://tex.stackexchange.com/questions/630889/marginnote-eats-first-item-in-thmtools-mdframed?noredirect=1#comment1600939_630889}
	postheadhook={\phantom{}\marginnote{\nirideasymbol}[-3pt]%
	\ifthmt@thisistheone% restatable makes alignment weird
		\hspace{-2.2pt}%
	\else%
		{}%
	\fi}
]{idea}

\declaretheorem[
	style=nirredbox,
	name=Warning,
	sibling=thm,
	% without phantom{}, the first item in a list gets misformatted
	postheadhook={\phantom{}\marginnote{\nirwarnsymbol}[-3pt]%
	\ifthmt@thisistheone% restatable makes alignment weird
		\hspace{-2.2pt}%
	\fi}
]{warn}
\makeatother

\definecolor{nirdarkgreen}{HTML}{20660a}
\definecolor{nirlightgreen}{HTML}{ebffeb}
\declaretheoremstyle[
	mdframed={
		backgroundcolor=nirlightgreen,
		linecolor=nirdarkgreen,
		rightline=false,
		topline=false,
		bottomline=false,
		linewidth=2pt,
		innertopmargin=5pt,
		innerbottommargin=8pt,
		innerleftmargin=8pt,
		leftmargin=-2pt,
		skipbelow=2pt,
		nobreak
	},
	headfont=\normalfont\bfseries\color{nirdarkgreen}
]{nirgreenbox}
\declaretheorem[style=nirgreenbox,name=Axiom,sibling=thm]{ax}
\declaretheorem[style=nirgreenbox,name=Axiom,sibling=thm]{axiom}
\declaretheorem[style=nirgreenbox,name=Inventory,sibling=thm]{inv}
\declaretheorem[style=nirgreenbox,name=Inventory,sibling=thm]{inventory}
\declaretheorem[style=nirgreenbox,name=Notation,sibling=thm]{notation}
\declaretheorem[style=nirgreenbox,name=Definition,sibling=thm]{defihelper}

\definecolor{nirdarkcyan}{HTML}{25805e}
\definecolor{nirlightcyan}{HTML}{edfffb}
\declaretheoremstyle[
	mdframed={
		backgroundcolor=nirlightcyan,
		linecolor=nirdarkcyan,
		rightline=false,
		topline=false,
		bottomline=false,
		linewidth=2pt,
		innertopmargin=5pt,
		innerbottommargin=8pt,
		innerleftmargin=8pt,
		leftmargin=-2pt,
		skipbelow=2pt,
		nobreak
	},
	headfont=\normalfont\bfseries\color{nirdarkcyan}
]{nircyanbox}
\declaretheorem[style=nircyanbox,name=Example,sibling=thm]{ex}
\declaretheorem[style=nircyanbox,name=Example,sibling=thm]{example}
\declaretheorem[style=nircyanbox,name=Non-Example,sibling=thm]{nex}
\declaretheorem[style=nircyanbox,name=Non-Definition,sibling=thm]{ndefi}
\declaretheorem[style=nircyanbox,name=Exercise,sibling=thm]{exercise}
\declaretheorem[style=nircyanbox,name=Exercise,sibling=thm]{exe}

\definecolor{nirlightbrown}{RGB}{252,240,235}
\definecolor{nirdarkbrown}{HTML}{7a5342}
\declaretheoremstyle[
	mdframed={
		backgroundcolor=nirlightbrown,
		linecolor=nirdarkbrown,
		rightline=false,
		topline=false,
		bottomline=false,
		linewidth=2pt,
		innertopmargin=5pt,
		innerbottommargin=8pt,
		innerleftmargin=8pt,
		leftmargin=-2pt,
		skipbelow=2pt,
		nobreak
	},
	headfont=\normalfont\bfseries\color{nirdarkbrown}
]{nirbrownbox}
\declaretheorem[style=nirbrownbox,name=Remark,sibling=thm]{remark}
\declaretheorem[style=nirbrownbox,name=Quote,sibling=thm]{quot}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /THM BOXES

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% INDEX BOXES
% smuggle the note from the header formatting
\makeatletter
\def\thmt@setheadstyle#1{%
	\thmt@style@headstyle{%
		\def\NAME{\the\thm@headfont ##1}%
		\def\NUMBER{\bgroup\@upn{##2}\egroup}%
		\def\NOTE{\if=##3=\else\bgroup\thmt@space\the\thm@notefont(##3)\egroup\fi}%
		% my precious!
		\def\NIRNOTE{\if=##3=\else##3\fi}%
	}%
	\def\thmt@tmp{#1}%
	\@onelevel@sanitize\thmt@tmp
	%\tracingall
	\ifcsname thmt@headstyle@\thmt@tmp\endcsname
		\thmt@style@headstyle\@xa{%
			\the\thmt@style@headstyle
			\csname thmt@headstyle@#1\endcsname
		}%
	\else
		\thmt@style@headstyle\@xa{%
			\the\thmt@style@headstyle
			#1%
		}%
	\fi
	%\showthe\thmt@style@headstyle
}
% disable indexing in restatable, as with labels
\renewenvironment{thmt@restatable}[3][]{%
	\thmt@toks{}% will hold body
%
	\stepcounter{thmt@dummyctr}% used for data storage label.
%
	\long\def\thmrst@store##1{%
		\@xa\gdef\csname #3\endcsname{%
			\@ifstar{%
				\thmt@thisistheonefalse\csname thmt@stored@#3\endcsname
			}{%
				\thmt@thisistheonetrue\csname thmt@stored@#3\endcsname
			}%
		}%
		\@xa\long\@xa\gdef\csname thmt@stored@#3\@xa\endcsname\@xa{%
			\begingroup
			\ifthmt@thisistheone
				% these are the valid numbers, store them for the other
				% occasions.
				\thmt@rst@storecounters{#3}%
			\else
				% this one should use other numbers...
				% first, fake the theorem number.
				\@xa\protected@edef\csname the#2\endcsname{%
					\thmt@trivialref{thmt@@#3}{??}}%
				% if the number wasn't there, have a "re-run to get labels right"
				% warning.
				\ifcsname r@thmt@@#3\endcsname\else
					\G@refundefinedtrue
				\fi
				% prevent stepcountering the theorem number,
				% but still, have some number for hyperref, just in case.
				\@xa\let\csname c@#2\endcsname=\c@thmt@dummyctr
				\@xa\let\csname theH#2\endcsname=\theHthmt@dummyctr
				% disable labeling.
				\let\label=\thmt@gobble@label
				% disable indexing!
				\let\index=\@gobble
				\let\ltx@label=\@gobble% amsmath needs this
				% We shall need to restore the counters at the end
				% of the environment, so we get
				% (4.2) [(3.1 from restate)] (4.3)
				\def\thmt@restorecounters{}%
				\@for\thmt@ctr:=\thmt@innercounters\do{%
					\protected@edef\thmt@restorecounters{%
						\thmt@restorecounters
						\protect\setcounter{\thmt@ctr}{\arabic{\thmt@ctr}}%
					}%
				}%
				% pull the new semi-static definition of \theequation et al.
				% from the aux file.
				\thmt@trivialref{thmt@@#3@data}{}%
			\fi
			% call the proper begin-env code, possibly with optional argument      
			% (omit if stored via key-val)
			\ifthmt@restatethis
				\thmt@restatethisfalse
			\else
				\csname #2\@xa\endcsname\ifx\@nx#1\@nx\else[{#1}]\fi
			\fi
			\ifthmt@thisistheone
				% store a label so we can pick up the number later.
				\label{thmt@@#3}%
			\fi
			% this will be the collected body.
			##1%
			\csname end#2\endcsname
			% if we faked the counter values, restore originals now.
			\ifthmt@thisistheone\else\thmt@restorecounters\fi
			\endgroup
		}% thmt@stored@#3
		% in either case, now call the just-created macro,
		\csname #3\@xa\endcsname\ifthmt@thisistheone\else*\fi
		% and artificially close the current environment.
		\@xa\end\@xa{\@currenvir}
	}% thm@rst@store
	\thmt@collect@body\thmrst@store
}{%
	%% now empty, just used as a marker.
}
\makeatother
\declaretheoremstyle[
	mdframed={
		backgroundcolor=nirlightgreen,
		linecolor=nirdarkgreen,
		rightline=false,
		topline=false,
		bottomline=false,
		linewidth=2pt,
		innertopmargin=5pt,
		innerbottommargin=8pt,
		innerleftmargin=8pt,
		leftmargin=-2pt,
		skipbelow=2pt,
		nobreak
	},
	headfont=\normalfont\bfseries\color{nirdarkgreen},
	headformat={\NAME\ \NUMBER\NOTE{\nirindex{\NIRNOTE}}}
]{nirgreenboxindexed}
\declaretheorem[style=nirgreenboxindexed,name=Definition,sibling=thm]{defi}
\declaretheorem[style=nirgreenboxindexed,name=Definition,sibling=thm]{definition}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% /INDEX BOXES