% !TEX root = ../notes.tex

\documentclass[../notes.tex]{subfiles}

\begin{document}

Today we prove our special case of the Shimura--Taniyama formula.

\subsection{Proving the Shimura--Taniyama Formula}
Here is our statement.
\begin{theorem}
	Fix a number field $K$, and let $A$ be an abelian $K$-variety with complex multiplication by the CM algebra $(E,\Phi)$. Further, we take the following extra assumptions.
	\begin{itemize}
		\item $K$ contains the Galois closure of $E$.
		\item $A$ has good reduction at some prime $\mf P$ of $K$, meaning that $\mc A$ is an abelian scheme.
		\item $K_\mf P$ is unramified over $\QQ_p$ where $p$. Set $\kappa\coloneqq\OO_K/\mf P$.
		\item $\op{End}(A)\cap E=\OO_E$.
	\end{itemize}
	Then there is some unique $\pi\in\OO_E$ such that the reduction of $\pi$ from $\OO_E\subseteq\op{End}A=\op{End}\mc A$ to $\op{End}\mc A_\kappa$ is $\op{Frob}$. In fact, $(\pi)$ is
	\[\prod_{\varphi\in\Phi}\varphi^{-1}\left(\op{Nm}_{K/\varphi(E)}\mf P\right).\]
\end{theorem}
\begin{proof}
	We begin by discussing how to get $\pi\in\OO_E$. Recall that the N\'eron mapping property yields $\op{End}A=\op{End}\mc A$, which embeds in $\mathrm{End}\mc A_\kappa$ because we can check the equality of two endomorphisms $\varphi,\psi\colon\mc A\to\mc A$ on the Zariski dense subset of prime-to-$p$ torsion of $\mc A$, which is already found in $\mc A_\kappa$ by \Cref{lem:torsion-everywhere-agrees}.

	Now, we know $E\subseteq\op{End}^0(A)\subseteq\op{End}\mc A_\kappa$, and there is some $\op{Frob}$ element. In fact, $\op{Frob}$ will commute with anything from $E$, which means that it must live in $E$, which can be seen directly from the Albert classification or more directly as follows: it suffices to check the commutativity on the Tate module. But then $V_\ell\mc A_\kappa$, but $\dim(E\otimes\QQ_\ell)=2\dim A$ (because $E$ is our CM algebra), and $V_\ell A_\kappa$ also has dimension $2\dim A$, and the relevant action is faithful on $A$ and hence faithful on $\mc A$ and hence faithful on $\mc A_\kappa$, so $V_\ell\mc A_\kappa$ is a faithful $(E\otimes\QQ_\ell)$-module of rank $1$. Thus, $\op{Frob}$ will have to live in $E\otimes\QQ_\ell$ and in $\op{End}\mc A_\kappa$, so it comes from $E\cap\op{End}A$, which is $\OO_E$. So $\op{Frob}$ comes from a unique element $\pi\in\OO_E$.

	We now turn to the second claim. Note the relative Frobenius $F\colon A\to A^{(1)}$ factors through $[p]$ (we showed this when discussing finite flat group schemes), so the full Frobenius $\op{Frob}$ factors through $[q]$. In fact, we can see this more explicitly via the following lemma.
	\begin{lemma} \label{lem:frob-through-q}
		Fix everything as above. Then
		\[{\op{Frob}}\circ{\op{Frob}}^\lor\stackrel?=[q]\]
		for any Rosati involution $(\cdot)^\dagger$.
	\end{lemma}
	\begin{proof}
		This is a matter of unraveling the definition. It will be enough to show that ${\op{Frob}}^\dagger\circ{\op{Frob}}=[q]$ by duality. Well, let $\lambda\colon A\to A^\lor$ be our polarization providing the Rosati involution, and then we see that
		\[{\op{Frob}_A}^\dagger\circ{\op{Frob}_A}=\lambda^{-1}\circ{\op{Frob}_A}^\lor\circ\lambda\circ\op{Frob}_A.\]
		This being equal to $[q]$, by rearranging, is equivalent to showing that
		\[{\op{Frob}_A^\lor}\circ{\op{Frob}_{A^\lor}}=[q].\]
		We will do this by hand. Fix a test $T$-scheme, and a rigidified line bundle $\mc L$ on $A\times T$ living in $A^\lor(T)$. We pass $\mc L$ through. For example,
		\[\op{Frob}_{A^\lor}(\mc L)=({\id}\times F_T^{(m)})^*\mc L,\]
		where $F_T^{(m)}$ means the relative Frobenius, and then applying the dual morphism $\op{Frob}_A^\lor$ leaves us with
		\[({\op{Frob}_A}\times{\id})^*({\id}\times F_T^{(m)})^*\mc L.\]
		So we see that we are just taking $q$th powers on both coordinates, which does indeed produce $\mc L^{\otimes q}$, as desired.
	\end{proof}

	The point is that $(\pi)$ is supported on $p\OO_E$, so we can write
	\[\pi=\prod_{v\mid p}\mf p_v^{m_v}\]
	for some nonnegative integers $m_v$. To make things principal, set $h\coloneqq\#\op{Cl}E$ so that $\mf p_v^{m_vh}$ can be said to be generated by some $\gamma_v\in\OO_E$. We will compute $\deg\gamma_v$ in two ways.
	\begin{lemma}
		Fix everything as above. For any $\alpha\in\OO_E$, the degree of $\alpha$ as an endomorphism $A\to A$ is $\op{Nm}_{E/\QQ}\alpha$.
	\end{lemma}
	\begin{proof}
		We may let $\alpha$ act on the Tate module $V_\ell\mc A_\kappa$, as discussed above. Then we previously showed that
		\[\deg\alpha=\det(\alpha|_{V_\ell\mc A_\kappa}),\]
		but we know $V_\ell\mc A_\kappa$ is just $E\otimes\QQ_\ell$, and multiplication by $\alpha$ then becomes the usual multiplication by $\alpha$ map $E\to E$. Thus, the determinant is indeed $\op{Nm}_{E/\QQ}\alpha$, as desired.
	\end{proof}
	The point is that
	\[\deg\gamma_v=\op{Nm}_{E/\QQ}\gamma_v=\op{Nm}_{E/\QQ}\mf p_v^{m_vh}.\]
	We now compute this $\deg\gamma_v$ differently. Because we are only interested in the degree, we may as well take $\kappa=\ov\kappa$.
	\begin{lemma}
		Fix an algebraically closed field $k$ of positive characteristic $p$, and set $q\coloneqq p^m$. Then any isogeny $f\colon A\to B$ of abelian $k$-varieties such that $f^*K(B)$ contains $K(A)^q$ has
		\[\deg f\le q^d,\]
		where $d=\dim\ker\op{Lie}f$.
	\end{lemma}
	\begin{proof}[Sketch]
		We will use \cite[Theorem~11.27]{milne-alg-grp}. Note that $\ker f$ is a local finite group $k$-scheme because $f$ factors through multiplication-by-$q$, from which one can see that
		\[\ker f=\Spec\frac{k[x_1,\ldots,x_n]}{\left(x_1^{p^{r_1}},\ldots,x_n^{p^{r_n}}\right)}\]
		with $r_i\le m$ for each $i$ and $n=\dim T_e\ker f$ by the proof of this result. Then one computes
		\[\deg f=\prod_{i=1}^mp^{r_i}\le p^{mn}=q^n,\]
		but $n=\dim T_e\ker f$ is $\dim\ker\op{Lie}f$.
	\end{proof}
	We are actually pretty happy that $\op{Lie}$ has appeared because we need to relate everything back to the CM type. In particular, we know that $\op{Lie}A$ admits a $K$-basis $(e_\varphi)_{\varphi\in\Phi}$, where $a\in E$ acts on $e_\varphi$ by $\varphi(a)$.

	Now, because $K_\mf P/\OO_p$ is unramified, we know that $\op{Lie}\mc A$ will admit an $\mathcal O_{K_\mf P}$-basis by $(e_\varphi)_{\varphi\in\Phi}$ again. Indeed, the point is that
	\[\OO_E\otimes_\ZZ\OO_{K_\mf P}=\bigoplus_{\sigma\colon E\subseteq K_\mf P}\OO_{K_\mf P}\]
	because we are unramified.\footnote{If we want to remove this unramified assumption, then we must work with more theory of $p$-divisible groups to make this sort of thing go through.} This basis then goes down to a basis $\{\ov e_\varphi\}_{\varphi\in\Phi}$ of $\op{Lie}\mc A_\kappa$ by reduction. Thus,
	\[\ker(\op{Lie}\gamma_v\colon\op{Lie}\mc A_\kappa\to\op{Lie}\mc A_\kappa)=\op{span}\{\ov e_\varphi:\varphi(\gamma_v)\in\mf P\}\]
	because our multiplication is basically coordinate-wise.

	To continue, we recall that
	\[H_v\coloneqq\left\{\tau\in\op{Hom}(E,K):\tau^{-1}\mf P=\mf p_v\right\}\qquad\text{and}\qquad\Phi_v\coloneqq\Phi\cap H_v.\]
	The point is that we know $\dim\ker(\op{Lie}\gamma_v)$ is exactly $\#\Phi_v$, meaning $\deg\gamma_v\le q^{h\#\Phi_v}$ by the previous lemma.

	Comparing our two expressions for the degree, we see that
	\[\op{Nm}_{E/\QQ}\mf p_v^{m_v}\le q^{\#\Phi_v}.\]
	We claim that we have equality. Well, using \eqref{lem:frob-through-q}, we see
	\[\op{Nm}_{E/\QQ}\pi=\deg{\op{Frob}}=q^{\dim A}\]
	because $\deg{\op{Frob}}=\deg\op{Frob}^\dagger$. On the other hand,
	\[\op{Nm}_{E/\QQ}\pi=\op{Nm}_{E/\QQ}\prod_{v\mid p}\mf p_v^{m_v}\le\prod_{v\mid p}q^{\#\Phi_v}=q^{\#\Phi}=q^{\dim A},\]
	so the inequality here sharpens to an equality.
	
	Thus, we achieve $(\op{Nm}_{K/\QQ}\mf P)^{\#\Phi_v}=\op{Nm}_{E/\QQ}\mf p_v^{m_v}$. On the other hand, decomposing the norm as a product of conjugates, we see
	\[\op{Nm}_{E/\QQ}\left(\prod_{\varphi\in\Phi_v}\varphi^{-1}(\op{Nm}_{K/\varphi(E)}\mf P)\right)=\prod_{\varphi\in\Phi}\op{Nm}_{K/\QQ}\mf P,\]
	so comparing our norms implies that
	\[\mf p_v^{m_v}=\prod_{\varphi\in\Phi_v}\varphi^{-1}(\op{Nm}_{K/\varphi(E)}\mf P).\]
	(In particular, both sides are powers of $\mf p_v$ by construction, so one only needs to compare exponents.) Looping over all $\varphi$ completes the proof.
\end{proof}
\begin{remark}
	The bulleted assumptions can essentially be removed, but we will not do so.
\end{remark}
\begin{remark}
	In fact, one can show that there is an explicit formula of $(\pi)\subseteq\OO_E$, which we will show next class.
\end{remark}

\end{document}