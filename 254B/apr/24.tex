% !TEX root = ../notes.tex

\documentclass[../notes.tex]{subfiles}

\begin{document}

Today we complete the proof of the main theorem of complex multiplication.

\subsection{More on \texorpdfstring{$\mf a$}{ a}-Multiplication}
For our set-up, we have a homomorphism $\lambda\colon A\to B$, where $A$ has CM type $(E,\Phi)$. Then let $\mf a$ be a lattice in $E$, and we assume that $B$ is an $\mathfrak a$-multiplication. On $\CC$, we can think of $A$ as $\CC^g/\Phi(\Lambda)$, and then it turns out that
\begin{proposition}
	Fix an abelian variety $A$ with CM type $(E,\Phi)$. With lattices $\mf a,\mf a'\subseteq E$, let $\lambda\colon A\to B$ and $\lambda A\to B'$ be an $\mathfrak a$-multiplication and an $\mathfrak a'$-multiplication, respectively. Then there exists an isogeny $f\colon B\to B'$ such that $\lambda'=f\lambda$ if and only if $\mf a\supseteq\mf a'$.
\end{proposition}
\begin{proof}
	If $\mf a\supseteq\mf a'$, one can build $f$ via the universal property of $\mf a$-multiplication. For the converse, we want to show that $\mf a=\mf a+\mf a'$. Let $\lambda''\to A\to B''$ be an $(\mathfrak a+\mf a')$-multiplication so that the universal properties everywhere induce maps as follows.
	% https://q.uiver.app/#q=WzAsMyxbMCwwLCJCJyciXSxbMSwwLCJCIl0sWzEsMSwiQiciXSxbMSwyLCJmIl0sWzAsMV0sWzAsMl1d&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
	\[\begin{tikzcd}
		{B''} & B \\
		& {B'}
		\arrow[from=1-1, to=1-2]
		\arrow[from=1-1, to=2-2]
		\arrow["f", from=1-2, to=2-2]
	\end{tikzcd}\]
	Thus,
	\[\frac{\ker\mf a}{\ker(\mf a+\mf a')}=\ker(B''\to B)\subseteq\ker(B''\to B)=\frac{\ker\mf a'}{\ker(\mf a+\mf a')}.\]
	Because $\ker\mf a\cap\ker\mf a'=\ker(\mf a+\mf a'')$, we see from the above computation that $B''\to B$ is injective, so $\mf a+\mf a'=\mf a$, as required.
\end{proof}
\begin{proposition} \label{prop:compose-a-mult}
	Fix an abelian variety $A$ with CM type $(E,\Phi)$. With lattices $\mf a,\mf a'\subseteq E$, let $\lambda\colon A\to A'$ and $\lambda A'\to A''$ be an $\mathfrak a$-multiplication and an $\mathfrak a'$-multiplication, respectively. Then $\lambda'\lambda\colon A\to A''$ is an $\mathfrak a\mf a'$-multiplication.
\end{proposition}
\begin{proof}
	One can just use the explicit construction of our $\mf a$-multiplications. For example, one can note that $A'=A/\ker\mf a=A\otimes_{\OO_E}\mf a^{-1}$ and then iterate this tensor product.
\end{proof}
\begin{proposition} \label{prop:deg-of-mult}
	Fix an abelian variety $A$ with CM type $(E,\Phi)$. With lattice $\mf a\subseteq\OO_E$, let $\lambda\colon A\to A'$ be an $\mathfrak a$-multiplication. Then $\deg\lambda=[\OO_E:\mf a]$.
\end{proposition}
\begin{proof}
	Over $\CC$, write $A=\CC^g/\Lambda$, so $\deg\lambda=\left[\mf a^{-1}\Lambda:\Lambda\right]=[\OO_E:\mf a]$ immediately.

	We now work over an arbitrary field. If $\mf a=(a)$ is principal with integral generator, then $[a]\colon A\to A$ is the required $a$-multiplication, which has the correct degree. In general, by using the previous proposition, we can find $\lambda'$ so that $\lambda'\lambda=[\alpha]$ for $\alpha\in\OO_E$, and we can further require that $\lambda'$ and $\lambda$ have coprime degree, and now we can finish.
\end{proof}
\begin{proposition} \label{prop:use-isog-to-mult}
	Fix abelian $\ov\QQ$-varieties $A$ and $B$ with CM by $E$, and assume $\OO_E\subseteq\op{End}A$ and $\OO_E\subseteq\op{End}B$. If there is an isogeny $f\colon A\to B$ preserving the $E$-action, then there is a lattice $\mf a\subseteq E$ and isogeny $\lambda\colon A\to B$ which is an $\mathfrak a$-multiplication.
\end{proposition}
\begin{proof}
	By Galois descent, we'll be able to work over $\CC$. Then $A(\CC)=\CC^g/\Phi(\mf b_1)$ and $B(\CC)=\CC^g/\Phi(\mf b_2)$ for fractional ideals $\mf b_1$ and $\mf b_2$, where $(E,\Phi)$ is the CM type. (The existence of the isogeny basically allows us to assume that $A$ and $B$ have the same CM type, which is why we used the same $\Phi$.) Then the point is that we can adjust our two abelian varieties up to isogeny to make our projection into a $\mf b_1\mf b_2^{-1}$-multiplication.
\end{proof}
We are now ready to prove \Cref{thm:ideal-theoretic-main}.
\begin{proof}
	We begin with the proof of (a). By \Cref{prop:use-isog-to-mult}, we can an isogeny $\lambda\colon A\to A^\sigma$ compatible with the $E$-action which is an $\mathfrak a$-multiplication, where $\mf a\subseteq\OO_E$ is some ideal. By \Cref{prop:deg-of-mult}, we see that $\deg f=[\OO_E:\mf a]$.

	Now, looking at our integer $m$, we may select some $a\in E^\times$ such that $a\mf a\subseteq\OO_E$ and $[\OO_E:a\mf a]$ is coprime to $m$; this is basically done by looking at the prime factorization of $m$ and of $\mf a$ and ``fixing'' the prime factorization to avoid the various primes. Replacing $\lambda$ by $a\lambda$ and $\mf a$ by $a\mf a$, we now know that $\lambda\colon A\to\mf A^\sigma$ is still an $\mathfrak a$-multipication, but now it has degree coprime to $m$.

	The point is that $\lambda\colon A[m]\to A^\sigma[m]$ factors through $[\deg f]_A$, which is an isomorphism on $m$-torsion, so $f$ is an isomorphism on $m$-torsion. Because $\sigma\colon A[m]\to A^\sigma[m]$ is also an isomorphism, and everything is compatible with the $E$-action, we are granted $\beta\in\OO_E$ such that\todo{Why?}
	\[\beta\equiv f^{-1}\circ\sigma\pmod m.\]
	As such, we finally define $\alpha\colon A\to A^\sigma$ as $f\circ\beta$ so that $\alpha|_{A[m]}=\sigma|_{A[m]}$, and we know $\alpha$ is now an $\mathfrak a(\sigma)$-multiplication for some ideal $\mf a(\sigma)$. Looking at our construction, $f$ is unique up to an element of $E^\times$, and because we are only looking at $m$-torsion, we only get uniqueness up to $E_{m,1}$. So $[\mf a(\sigma)]$ is really an ideal class in $I^{S(\mf m)}/E_{m,1}$, which is $\op{Cl}^m_E$, as required.\todo{What?}

	We now turn to (b). Suppose $\alpha\colon A\to A^\sigma$ is an $\mathfrak a(\sigma)$-multiplication, and $\alpha'\colon A\to A^{\sigma'}$ is an $\mathfrak a(\sigma')$-multiplication. Then $(\alpha')^\sigma\alpha\colon A\to A^{\sigma\sigma'}$ is an $\mathfrak a(\sigma)\mf a(\sigma')$-multiplication by \Cref{prop:compose-a-mult}, so we have produced a group homomorphism
	\[\op{Gal}(\ov\QQ/E^\times)\to\op{Cl}^m_E\]
	given by $\sigma\mapsto[\mf a(\sigma)]$. By continuity, this must factor through some $\op{Gal}(L_{\mf m}/E^*)$ for sufficiently large $\mf m$ (as restriction), so (b) follows.
\end{proof}

\subsection{Completing the Proof}
We are going to combine the Shimura--Taniyama formula with \Cref{thm:ideal-theoretic-main} to conclude our proof. Fix an abelian variety $A$ over a number field $K$ with CM type $(E,\Phi)$, and suppose that $K$ is Galois and contains all Galois conjugates of $E$. Fix a prime $p$, and let $\mf p$ be a prime of $E^*$ above $p$, and let $\mf P$ be a prime of $K$ above $\mf p$. We will further assume that $K_{\mf P}/\QQ_p$ is unramified and that $\OO_E\subseteq\op{End}A$.
\begin{corollary}
	Fix everything as above.
	\begin{listalph}
		\item There exists an $\mathfrak a$-multiplication $\alpha\colon A\to A^\sigma$ (defined over a finite extension of $K$) where $\sigma\in\op{Gal}(K/E^*)$ reduces to the Frobenius automorphism of $\kappa(\mf P)/\kappa(\mf p)$.
		\item In fact, $\mf a=\op N_\Phi(\mf p)$.
	\end{listalph}
\end{corollary}
\begin{proof}
	From \Cref{thm:ideal-theoretic-main}, we get some $f\colon A\to A^\sigma$ which is a $\mf b$-multiplication, so the same is true after passing to the reductions $A_0$ and $A_0^\sigma$ over $\kappa(\mf P)$, for example by considering the construction of $\mf b$-multiplications as a tensor product. Now, because we have $\mf b$-multiplications, we see
	\[\op{Hom}_E(A,A^\sigma)=\mf b^{-1}=\mf b^{-1}=\op{Hom}_E(A,A^\sigma),\]
	so our Frobenius $A_0\to A_0^\sigma$ lifts to $\alpha\colon A\to A^\sigma$ (where we are implicitly using the N\'eron mapping property).
\end{proof}
We will complete the proof next class.

\end{document}