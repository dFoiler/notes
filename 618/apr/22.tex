% !TEX root = ../notes.tex

\documentclass[../notes.tex]{subfiles}

\begin{document}

\section{April 22}
Today we complete our discussion of Waldspurger's formula.

\subsection{Upgrading Matching}
For the time being, we work locally over some $F_v$. Another way to look at \Cref{thm:better-compare} is that the two projections $\pi_T\colon(T\backslash G/T)\to\AA^1$ and $\pi_A\colon(A\backslash A/A)\to\AA^1$ produces an inclusion
\[\pi_{T!}(S(T\backslash G))\subsetneq\pi_{A!}(S(A\backslash G))\]
which is compatible with the spherical Hecke algebra (in the sense discussed in the statement of the fundamental lemma). It is desirable to upgrade the above into a full equality so that one can prove a full form of Waldspurger's formula. Of course, the problem is that we only had access to ``half'' of the space with $\pi_{T!}$.

To attain a full matching, we need to add in the missing piece. Note that $Y\coloneqq T\backslash G$ lives over $\AA^1$, and its fibers (away from $0$ and $1$) are some $T$-torsors (because $T\backslash G//T\to\AA^1$ is an isomorphism). Half the time, the fiber over $\xi\in\AA^1$ is the trivial torsor (namely, when $\xi$ is a norm), and otherwise the fiber is empty. Now, let $R$ be the nontrivial $T$-torsor, and we find that
\[Y^R\coloneqq(Y\times_TR)=Y\times_G(G\times_TR)\]
has fibers which are now nontrivial over the other $\xi$s! In other words, when the fiber over some $\xi$ is $R$ (and in particular the empty $T$-torsor), we find that the fiber over $\xi$ of $Y^R$ becomes $R\times_TR$, which is $T$ because $T$ has only two $T$-torsors.
\begin{remark}
	The automorphisms of $G$ as a $G$-variety (with left action by translation) is simply given by $G$ acting on the right. Analogously, the automorphisms of $G$ acting on some $G$-torsor will again simply be given by a form of $G$ because this group must become $G$ once the $G$-torsor is trivialized.
\end{remark}
\begin{remark}
	Let's think a bit about forms. Note that there is a sequence of maps
	\[\mathrm H^1(\mathrm{Gal}_F,G)\to\mathrm H^1(\mathrm{Gal}_F,\op{Inn}G)\to\mathrm H^1(\mathrm{Gal}_F,\op{Aut}(G)).\]
	The last group parameterizes forms of $G$, and the middle groups classifies inner forms, and the first groups classifies pure inner forms (or $G$-torsors). Notably, the data of an inner form might be more than merely a form of $G$ which happens to be in the image of the map from the middle group to the right group.
\end{remark}
\begin{example}
	Take $G=\mathrm{GL}_n$.
	\begin{itemize}
		\item Then $\mathrm H^1(\mathrm{Gal}_F,G(\ov F))$ is trivial: this is parameterizing $G$-torsors, which are vector bundles over $\Spec F$, which are just vector spaces over $F$. There is only one such vector space, up to isomorphism.
		\item Continuing, $\mathrm H^1(\mathrm{Gal}_F,\op{Inn}G)=\mathrm H^1(\mathrm{Gal}_F,\op{PGL}_n(\ov F))$. Now, $\op{PGL}_n$ can be thought of as automorphisms of $\PP^n$ or as automorphisms of $M_n(\ov F)$, so this parameterizes forms of $\PP^n$ or central simple algebras over $F$ of dimension $n^2$. Note that this can be mapped to the Brauer group $\mathrm H^2(\mathrm{Gal}_F,\mathbb G_m)$ via a suitable long exact sequence. The corresponding forms of $G$ are the ones which look like $D^\times$.
		\item Lastly, $\op{Aut}G=\op{Inn}G\rtimes(\ZZ/2\ZZ)$, where the extra $\ZZ/2\ZZ$ comes from the inverse transpose automorphisms. Thus, the forms given by $\mathrm H^1(\mathrm{Gal}_F,G)$ can either be inner of the form $D^\times$ (where $D$ is a central simple algebra of dimension $D$) or a unitary group (which corresponds to Galois acting nontrivially on the $\ZZ/2\ZZ$ piece).
	\end{itemize}
\end{example}
\begin{example}
	Take $G=\op{SO}_n$. Note $\op{SO}_n$ is automorphisms of the data of a vector space $V$ of dimension $n$, a quadratic form $q$ up to isomorphism, and a nonzero vector $\omega$ in $\land^nV$ (to keep track of orientation), though we need an extra condition so that $q$ and $\omega$ have a coherence condition (namely, the discriminant of $q$ agrees with $\omega$). 
\end{example}
\begin{example}
	Similarly, $\mathrm H^1(\mathrm{Gal}_F,\mathrm O_n(\ov F))$ classifies quadratic spaces $(V,q)$ of dimension $n$, which are notably by the quotient
	\[\frac{(\mathrm O_n\backslash\mathrm{GL}_n)(F)}{\op{GL}_n(F)}.\]
\end{example}
\begin{example}
	Take $G=T$ to be the torus above, which we see is $\op{SO}_2$ because it is the kernel of some quadratic form.
	\begin{itemize}
		\item Then $\mathrm H^1(\mathrm{Gal}_F,T)$ is given by the space of quadratic spaces of dimension $2$ with discriminant equal to the discriminant of the norm map $\op N_{K/F}$ (viewed as a class in $F^\times/F^{\times2}$).
		\item The torus $T$ is abelian, so it has no inner forms.
		\item Lastly, $\op{Aut}T=\op{Aut}T$ because this is some abelian group.
	\end{itemize}
\end{example}
Notably, $Y^R$ is seen to be a torsor of $G^R$; note that $T$ admitting no inner forms means that $T$ must then still act on $Y^R$ (on the right) and hence embeds in the automorphism group $G^R$! More generally, there is a map from $T$-torsors to $G$-torsors by taking $(G\times_T-)$, so one can take automorphisms suitably to see this action.

Now, the discussion above tells us that $G^R$ should be something which looks like $\mathrm PD^\times$, where $D$ is a quaternion algebra.
\begin{remark}
	Let's discuss how quaternion algebras come about. Locally, there is an invariant map $\op{inv}_v\colon\op{Br}F_v\to\QQ/\ZZ$ which is an isomorphism when $v$ is nonarchimedean (and is an isomorphism on $\frac12\ZZ/\ZZ$ when $v$ is archimedean). Thus, there are only two quaternion algebras. Globally, there is a short exact sequence
	\[0\to\op{Br}F\to\bigoplus_v\op{Br}F_v\stackrel{\sum\mathrm{inv}}\to\QQ/\ZZ\to0,\]
	so the quaternion algebras (given by $2$-torsion) can simply be parameterized by some finite set $\Sigma$ of places with even cardinality to denote the locations of $1/2$ of a tuple in $\bigoplus_v\op{Br}F_v=\bigoplus_v\QQ/\ZZ$. We will let $D_\Sigma$ denote the corresponding quaternion algebra.
\end{remark}
\begin{remark}
	It follows from the theory of central simple algebras that having an embedding $K^\times\into D^\times$ (where $[K:F]=2$ and $[D:F]=2^2$) forces $D$ to split over $K$; i.e., $D_K^\times=\mathrm{GL}_{2,K}$. Locally, this means that every quadratic extension of $F_v$ embeds into $D^\times$. (Yiannis (casually) claims that one can prove local class field theory in this manner.) Turning this into some global statement, suppose that $D$ splits over a global extension $K/F$. For places $v$ of $F$ where $D_v$ is non-split, there are two cases.'
	\begin{itemize}
		\item If $v$ is split in $K$, then $D_v$ will continue to be non-split over every completion in $K\otimes F_v$.
		\item If $v$ is non-split in $K$, then $K_v$ is some field and hence embeds into $D_v$, so $D_v$ automatically splits over $K_v$.
	\end{itemize}
	Concretely, for our $D_\Sigma$, if $D_\Sigma$ splits over $K/F$, then we are forced to have this be true locally, so each $v\in\Sigma$ must be non-split in $K$.
\end{remark}
The moral of the story is that, locally, we can upgrade the proof from last class to produce an isomorphism
\[\pi_{T!}(S(T\backslash G))\oplus\pi_{T!}\left(S(T\backslash G^R)\right)\cong\pi_{A!}(S(A\backslash G)).\]
The moral is that each summand deals with half of a matching statement. Globally, one needs a relative trace formula $\op{RTF}^T_R$ for the pair $\left(G^R,T\right)$ for a given form $R$ of $T$, which must then look like $\mathrm PD^\times$ for some quaternion algebra $D$. The geometric expansion then looks like
\[\op{RTF}^T_R(f)=J_0(f)+J_1(f)+\sum_{\xi\in U(F)}\OO_\xi(f),\]
where $\OO_\xi(f)$ continues to be the same orbital integral, and $J_0$ and $J_1$ are some contributions coming from $0$ and $1$.

At long last, here is our upgraded global matching statement.
\begin{theorem}
	For all $(f_R)\in\bigoplus_RS\left(T\backslash G^R(\AA_F)\right)$, there exists is $f'\in S(A\backslash G(\AA_F))$ such that
	\[\sum_R\mathrm{RTF}_R^T(f_R)=\op{RTF}^A(f').\]
	The opposite is also true (namely, for all $f'$, there exists $f$). Furthermore, these mappings are compatible with spherical Hecke algebras: if $v$ is a place of $F$ where $K/F$ is unramified, and $f_R$ is unramified at $v$ (notably, $f|_{G^R}=0$ if $R$ is ramified at $v$), then $f'$ can also be taken to be unramified at $v$; further, the action by the Hecke algebra $\mathcal H(G(F_v),G(\OO_v))$ agrees on both sides.
\end{theorem}
This gives a full geometric comparison of our relative trace formulae.

\subsection{Spectral Comparison}
It remains to do spectral comparison. Namely, moving now to the spectral side, there is an equality
\[\bigoplus_R\int_{\widehat{G_R}}J^T_{R,\pi}(f)\,d\pi=\int_{\widehat G}J_\pi^A(f')\,d\pi,\]
for suitably interpretations of these integrals. Notably, the left-hand side is made of terms which look like $\int_{[T]}\varphi_1(t)\,dt\overline{\int_{[T]}\varphi_2(t)\,dt}$, and the right-hand side is made of terms like $\int_{[A]}\varphi_1(a)\,da\overline{\int_{[A]}\varphi_2(a)\eta(a)\,da}$. We are hoping to achieve an equality like
\[\sum_RJ^T_{R,\pi}(f)\stackrel?=J_\pi^A(f').\]
This then proves that the non-vanishing $L(\pi,1/2)L(\pi\otimes\eta,1/2)\ne0$ is equivalent to having some $R$ for which $J_{R,\pi}^T(f)\ne0$ (i.e., the integral over $[T]$ restricted to the $\pi$-component is nonzero).
\begin{remark}
	Technically, this does not make sense: $\pi$ on the right is an automorphic form of $\op{PGL}_2$ while $\pi$ on the left is an automorphic form of $\mathrm PD^\times$, where $D$ is given by $R$. To fix this, we could use the Jacquet--Langlands correspondence: we note that $G^R$ and $G$ are still isomorphic almost everywhere locally, so one can hope to build a bijection between these automorphic forms by requiring there to be some $\pi^R$ to be isomorphic to a given $\pi$ at the places where $G^R$ is isomorphic to $G$. (Note this property determines at most one automorphic form $\pi^R$ by strong multiplicity one.)
\end{remark}
Let's discuss how to do this spectral isolation. Fix a large finite set of places $\Sigma$: $\Sigma$ should contain nonarchimedean places, places ramified for $K/F$, and maybe more later on to include some ramified places for our automorphic form $\pi$ of $G$. We now fix some matching functions $(f_{\Sigma,R})$ and $f'_\Sigma$ locally over the places of $\Sigma$, and we will let our matching functions away from $\Sigma$ vary. For example, there is a Hecke algebra action by
\[\mc H^\Sigma\coloneqq\bigoplus_{v\notin\Sigma}'\mc H(G(F_v),G(\OO_v)),\]
and we go ahead and define functionals $\op{RTF}^T_\Sigma$ and $\op{RTF}^A_\Sigma$ on $\mc H^\Sigma$ by taking $h\mapsto\op{RTF}^\bullet(h\otimes f_\Sigma)$. Now, the spectral decomposition of the relative trace formula yields
\[\op{RTF}^A_\Sigma(h)=\int_{\widehat G}J_\pi^A(h\otimes f'_\Sigma)\,d\pi,\]
and we see that this integral vanishes for $\pi$ unramified outside $\Sigma$ because we are acting by this unramified test function $h\otimes f'_\Sigma$ there. On the other hand, for $\pi$ unramified outside $\Sigma$, we get contribution by the Hecke eigenvalue $\widehat h(\pi)$ to see
\[\op{RTF}^A_\Sigma(h)=\int_{\widehat G} \widehat h(\pi)J_\pi^A(1_{G(\OO^\Sigma)}\otimes f_\Sigma')\,d\pi.\]
One has a similar spectral expansion on the other side of our comparison of relative trace formulae, writing
\[\op{RTF}^T_{\Sigma}(h)=\sum_R\int_{\widehat{G^R}}\widehat h(\pi^R)J^A_{\pi^R}(1_{G(\OO^\Sigma)}\otimes f_\Sigma)\,d\pi.\]
Let's now use something about the Hecke algebra: by the Iwasawa decomposition, we see $\mc H(G(F_v),\OO(F_v))$ is simply $\CC[T_v]$, where $T_v$ is the class $G(\OO_v)\begin{bsmallmatrix}
	\varpi_v \\ & 1
\end{bsmallmatrix}G(\OO_v)$. Then some $\pi$ produces a functional $\pi_v\colon h\mapsto\widehat h(\pi_v)$ on the Hecke algebra. Thus, $\mc H^\Sigma$ can be thought of as a polynomial algebra on the polynomial ring over the letters $\{T_v\}_{v\in\Sigma}$, and we see that $\widehat h(\pi)$ and $\widehat h(\pi^R)$. Thus, our comparison of relative trace formula is more or less an equality of two large measures against these polynomial rings.

\end{document}