% !TEX root = ../notes.tex

\documentclass[../notes.tex]{subfiles}

\begin{document}

\section{January 30}

Starting next week, we will meet in Krieger 204. Office hours are right after class.

\subsection{Adding Level Structure}
As usual, we let $\OO$ be an order of an imaginary quadratic field $K$ of conductor $f$; throughout, we fix an embedding of $K$ into a fixed algebraically closed field $k$ of characteristic $0$.

We begin today by sharpening our main theorem. We began by saying that we are interested in $K^{\mathrm{ab}}$, but it is not enough to look at the Hilbert class field of $\op{Cl}(\OO)$, and it is even not enough to look at the union of all the Hilbert class fields.
\begin{remark}
	Let's describe some fields we cannot from this Hilbert class field construction. By class field theory, we see that we are interested in knowing how small
	\[\bigcap_f\widehat\OO_f^\times\subseteq\AA_K^\times\]
	is, where $\OO_f\subseteq\OO_K$ is the order of conductor $f$. This can be seen in the computation of $\widehat\OO_f^\times$ executed in \Cref{prop:better-order-class-group}; we will run this computation on the homework.
\end{remark}
To get the remaining abelian extensions, we add level structure. Level structure is an important notion in the realm of moduli spaces (and Shimura varieties more specifically), so this is a natural thing to do.
\begin{notation}
	Fix an algebraically closed field $k$ of characteristic $0$ and an order $\OO$ of an imaginary quadratic field $K$. Given a positive integer $N$, we define $Y_\OO(N)\subseteq Y(N)$ as collections of pairs $(Y,\tau)$ where $E\in Y_\OO$ and $\tau\colon E[N]\to(\OO/N\OO)$ is an isomorphism. We also write $Y_\OO(\infty)$ to mean keeping track of ``full'' level structure, which amounts to having an isomorphism
	\[\tau\colon\limit_NE[N]\to\widehat\OO^2.\]
\end{notation}
\begin{remark}
	The last isomorphism amounts to having a list of isomorphisms $T_pE\cong\OO\otimes\ZZ_p$ for all primes $p$ (via the Chinese remainder theorem).
\end{remark}
\begin{remark}
	We quickly check that $E[N]$ is in fact free of rank $1$ over $\OO/N\OO$, which explains why these level structure maps $\tau$ can all exist. The definition of everything can come down to an algebraically closed field of finite transcendence degree over $\QQ$, so it suffices to check this over $\CC$. But now $E(\CC)=\CC/\mf a$, so the $N$-torsion is isomorphic to $\frac1N\mf a/\mf a$, which we see is in fact free of rank $1$ over $\OO/N\OO$.
\end{remark}
The class group action on $Y_\OO$ now upgrades to a richer action of the idele class group. We begin by explaining how to add level structure to the class group. The following result is essentially a refinement of \Cref{prop:better-order-class-group}.
\begin{notation}
	Fix an order $\OO$ of an imaginary quadratic field $K$. For positive integer $N\ge1$, we define the group $\op{Cl}(\OO)(N)$ as consisting of isomorphisms classes of pairs $(\mf a,\tau)$ where $\mf a$ is a line bundle, and $\tau\colon\mf a/N\mf a\to\OO/N\OO$ is some isomorphism. Similarly, we define the group $\op{Cl}(\OO)(\infty)$ as consisting of isomorphisms classes of pairs $(\mf a,\tau)$ where $\mf a$ is a line bundle, and $\tau$ is a level structure isomorphism
	\[\widehat\OO\cong\limit_N\mf a/N\mf a.\]
\end{notation}
\begin{remark}
	Let's explain how this is a group: two pairs $(\mf a,\tau)$ and $(\mf a',\tau')$ can be multiplied by the tensor product $(\mf a\otimes\mf a',\tau\otimes\tau')$, where $(\tau\otimes\tau')$ is the composite
	\[\widehat\OO=\widehat\OO\otimes\widehat\OO\cong\limit_N\mf a/N\mf a\otimes\limit_N\mf a'/N\mf a'=\limit_N(\mf a\otimes\mf a')/N(\mf a\otimes\mf a').\]
	For example, the identity is $(\OO,{\id_{\widehat\OO}})$, and inverses can be constructed by inverting the line bundle.
\end{remark}
\begin{lemma} \label{lem:adelic-class-group-level}
	Fix an order $\OO$ of an imaginary quadratic field $K$. Then the isomorphism (b) of \Cref{prop:better-order-class-group} upgrades to an isomorphism between $K^\times\backslash\AA_K^\times$ and the group $\op{Cl}(\OO)(\infty)$ of pairs $(\mf a,\tau)$ where $\mf a\in\op{Cl}(\OO)$ and $\tau$ is a level structure isomorphism
	\[\widehat\OO\cong\limit_N\mf a/N\mf a.\]
\end{lemma}
\begin{proof}
	We proceed as in the proof of (b) of \Cref{prop:better-order-class-group}. We begin by describing the map. Fix some pair $(\mf a,\tau)$, and we remark that the data of $\tau$ (by the Chinese remainder theorem) provides equivalent data to a collection of isomorphisms
	\[\tau_p\colon\widehat\OO_p\to\limit\mf a/p^\bullet\mf a,\]
	and this right-hand side is simply $\mf a\otimes_\ZZ\ZZ_p$. To define our map, choose an open subset $U\subseteq\Spec\ZZ$ such that there is an isomorphism $\varphi\colon\mf a_U\to\OO_U$. Then for each prime $p$, we define $\alpha_p$ as the image of $1$ under the long composite
	\[K_p=\OO_U\otimes_{\ZZ_U}\QQ_p\stackrel\varphi\cong\mf a_U\otimes_{\ZZ_U}\QQ_p=\mf a\otimes_\ZZ\ZZ_p\otimes_{\ZZ_p}\QQ_p\stackrel{\tau_p}\cong\widehat\OO_p\otimes_{\ZZ_p}\QQ_p=K_p.\]
	We now check that the tuple $(\alpha_p)_p$ defines an element of $\AA_K^\times$ and then provides a well-defined bijection to $K^\times\backslash\AA_K^\times$.
	\begin{itemize}
		\item We claim that $(\alpha_p)_p\in\AA_K^\times$. Certainly $\alpha_p\in K_p^\times$ for all $p$, because the long composite is an isomorphism of $K_p$-modules. Additionally, for each $p\in U$, we see that the long composite can also be seen as
		\[\widehat\OO_p=\OO_U\otimes_{\ZZ_U}\ZZ_p\stackrel\varphi\cong\mf a_U\otimes_{\ZZ_U}\ZZ_p=\mf a\otimes_\ZZ\ZZ_p\stackrel{\tau_p}\cong\widehat\OO_p,\]
		allowing us to conclude that $\alpha_p\in\widehat\OO_p^\times$ for all $p\in U$. So we are done after noting that all but finitely many primes live in $U$.

		\item We claim that the class of $(\alpha_p)_p$ in $K^\times\backslash\AA_K^\times$ does not depend on the choice of $U$. Well, suppose that we are given two local trivializations $\varphi\colon\mf a_U\to\OO_U$ and $\psi\colon\mf a_V\to\OO_V$, which produce the elements $(\alpha_p)_p\in\AA_K^\times$ and $(\beta_p)_p\in\AA_K^\times$. Well, the image of $1$ under the composite
		\[K=\OO_U\otimes_{\ZZ_U}\QQ\stackrel\varphi\cong\mf a_U\otimes_{\ZZ_U}\QQ=\mf a_V\otimes_{\ZZ_V}\QQ\stackrel\psi\cong\OO_V\otimes_{\ZZ_V}\QQ=K\]
		produces some $\gamma\in K$. Then the construction of $\gamma$ makes the left square of the diagram
		% https://q.uiver.app/#q=WzAsNixbMCwwLCJLX3AiXSxbMSwwLCJcXG1mIGFfVVxcb3RpbWVzX3tcXFpaX1V9XFxRUV9wIl0sWzAsMSwiS19wIl0sWzEsMSwiXFxtZiBhX1ZcXG90aW1lc197XFxaWl9WfVxcUVFfcCJdLFsyLDAsIktfcCJdLFsyLDEsIktfcCJdLFsxLDAsIlxcdmFycGhpIiwyXSxbMywyLCJcXHBzaSIsMl0sWzAsMiwiXFxiZXRhIiwyXSxbMSwzLCIiLDEseyJsZXZlbCI6Miwic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFsxLDQsIlxcdGF1X3AiXSxbMyw1LCJcXHRhdV9wIl0sWzQsNSwiIiwxLHsibGV2ZWwiOjIsInN0eWxlIjp7ImhlYWQiOnsibmFtZSI6Im5vbmUifX19XV0=&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
		\[\begin{tikzcd}
			{K_p} & {\mf a_U\otimes_{\ZZ_U}\QQ_p} & {K_p} \\
			{K_p} & {\mf a_V\otimes_{\ZZ_V}\QQ_p} & {K_p}
			\arrow["\gamma"', from=1-1, to=2-1]
			\arrow["\varphi"', from=1-2, to=1-1]
			\arrow["{\tau_p}", from=1-2, to=1-3]
			\arrow[equals, from=1-2, to=2-2]
			\arrow[equals, from=1-3, to=2-3]
			\arrow["\psi"', from=2-2, to=2-1]
			\arrow["{\tau_p}", from=2-2, to=2-3]
		\end{tikzcd}\]
		commute, thereby showing $\alpha_p=\gamma\beta_p$ for all primes $p$. Thus, our idele is well-defined in $K^\times\backslash\AA_K^\times$.

		\item We claim that the idele class also does not depend on the isomorphism class of $(\mf a,\tau)$. This is a matter of tracking everything through: an isomorphism $(\mf a,\tau)\cong(\mf a',\tau')$ amounts to an isomorphism $\mf a\cong\mf a'$ commuting with the choice of level structure isomorphisms $\tau$ and $\tau'$, thereby producing a commutative diagram
		% https://q.uiver.app/#q=WzAsNixbMCwwLCJLX3AiXSxbMSwwLCJcXG1mIGFfVVxcb3RpbWVzX3tcXFpaX1V9XFxRUV9wIl0sWzAsMSwiS19wIl0sWzEsMSwiXFxtZiBhX1ZcXG90aW1lc197XFxaWl9WfVxcUVFfcCJdLFsyLDAsIktfcCJdLFsyLDEsIktfcCJdLFsxLDAsIlxcdmFycGhpIiwyXSxbMywyXSxbMSwzXSxbMSw0LCJcXHRhdV9wIl0sWzMsNSwiXFx0YXVfcCciXSxbNCw1LCIiLDEseyJsZXZlbCI6Miwic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFswLDIsIiIsMSx7ImxldmVsIjoyLCJzdHlsZSI6eyJoZWFkIjp7Im5hbWUiOiJub25lIn19fV1d&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
		\[\begin{tikzcd}
			{K_p} & {\mf a_U\otimes_{\ZZ_U}\QQ_p} & {K_p} \\
			{K_p} & {\mf a_V\otimes_{\ZZ_V}\QQ_p} & {K_p}
			\arrow[equals, from=1-1, to=2-1]
			\arrow["\varphi"', from=1-2, to=1-1]
			\arrow["{\tau_p}", from=1-2, to=1-3]
			\arrow[from=1-2, to=2-2]
			\arrow[equals, from=1-3, to=2-3]
			\arrow[from=2-2, to=2-1]
			\arrow["{\tau_p'}", from=2-2, to=2-3]
		\end{tikzcd}\]
		once we choose a local trivialization $\varphi\colon\mf a_U\to\OO_U$. So we see that the ideles produced by $(\mf a,\tau)$ and $(\mf a',\tau')$ are the same.

		\item We quickly note that the given map is a group homomorphism: multiplication of pairs is given by $(\mf a,\tau)\cdot(\mf a',\tau')=(\mf a\otimes\mf a',\tau\otimes\tau')$ (where we are viewing $\op{Cl}(\OO)$ as providing isomorphism classes of line bundles). Then running the above construction to take two trivializations $\varphi\colon\mf a_U\to\OO_U$ and $\varphi'\colon\mf a'_U\to\OO_U$ (for $U$ small enough), we see that we can take the tensor product of the two composites $K_p\to K_p$ (one for $\mf a$ and one for $\mf a'$) to reveal that the trivialization $(\varphi\otimes\varphi')\colon(\mf a\otimes\mf a')_U\to\OO_U$ yields the product of the ideles given by $\mf a$ and $\mf a'$ respectively.

		\item We check that our map extends the one of \Cref{prop:better-order-class-group}. Namely, we must check that the diagram
		% https://q.uiver.app/#q=WzAsNCxbMCwwLCJLXlxcdGltZXNcXGJhY2tzbGFzaFxcQUFfS15cXHRpbWVzIl0sWzAsMSwiS15cXHRpbWVzXFxiYWNrc2xhc2hcXEFBX0teXFx0aW1lcy9UKFxcd2lkZWhhdFxcWlopIl0sWzEsMCwiXFxvcHtDbH0oXFxPTykoXFxpbmZ0eSkiXSxbMSwxLCJcXG9we0NsfShcXE9PKSJdLFswLDJdLFsxLDNdLFswLDFdLFsyLDNdXQ==&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
		\[\begin{tikzcd}
			{\op{Cl}(\OO)(\infty)} & {K^\times\backslash\AA_K^\times} \\
			{\op{Cl}(\OO)} & {K^\times\backslash\AA_K^\times/T(\widehat\ZZ)}
			\arrow[from=1-1, to=1-2]
			\arrow[from=1-1, to=2-1]
			\arrow[from=1-2, to=2-2]
			\arrow[from=2-1, to=2-2]
		\end{tikzcd}\]
		commutes, where the bottom map is given by \Cref{prop:better-order-class-group}.
		
		This amounts to recasting the bottom map as follows. The bottom map takes $\mf a\in\op{Cl}(\OO)$, chooses a local trivialization $\varphi\colon\mf a_U\to\OO_U$, and then it produces an idele $(\alpha_p)_p$ by letting $\alpha_p$ be the image under the composite
		\[K_p=\OO_U\otimes_{\ZZ_U}\QQ_p\stackrel\varphi\cong\mf a_U\otimes_{\ZZ_U}\QQ_p=\mf a_{U_p}\otimes_{\ZZ_{U_p}}\QQ_p\stackrel{\tau_p}\cong\OO_{U_p}\otimes_{\ZZ_{U_p}}\QQ_p=K_p,\]
		where $\tau_p\colon\mf a_{U_p}\to\OO_{U_p}$ is some other chosen local trivialization. It is now relatively clear that this map is simply the above map after being forced to find of all ``level structure isomorphisms'' $\tau_p$.

		\item We check that the given map is injective. Suppose some pair $(\mf a,\tau)$ produces an idele $(\alpha_p)_p\in\AA_K^\times$ which is actually some element $\alpha\in K^\times$. Then we must show that $(\mf a,\tau)$ is trivial. Note that the idele is certainly trivial in the double quotient $K^\times\backslash\AA_K^\times/T(\widehat\ZZ)$, so \Cref{prop:better-order-class-group} allows us to assume that $\mf a$ is trivial and hence equal to $\OO$.
		
		Thus, we may choose the local trivialization $\varphi$ to be the identity $\OO=\OO$, and we see that $\alpha_p$ becomes the image of $1$ under the isomorphism $\tau_p\colon\widehat\OO_p\to\widehat\OO_p$. For example, this implies that $\alpha\in\OO^\times$. Thus, we see that the isomorphism $\alpha\colon\OO\to\OO$ provides an isomorphism between $(\OO,\tau)$ and the identity $(\OO,{\id})$ of $\op{Cl}(\OO)(\infty)$.

		\item We check that the given map is surjective. By the surjectivity that we already have from \Cref{prop:better-order-class-group}, it is enough to surject onto $T(\widehat\ZZ)$. Well, note that any $\tau\in T(\widehat\ZZ)$ induces an automorphism $\tau\colon\widehat\OO^\times\to\widehat\OO^\times$ (given by multiplication). Then the pair $(\OO,\tau)\in\op{Cl}(\OO)(\infty)$ goes to $\tau\in T(\widehat\ZZ)$ by construction: use $\id\colon\OO\to\OO$ for the local trivialization, and then the produced idele can be seen to be $\tau$ by construction.
		\qedhere
	\end{itemize}
\end{proof}
\begin{lemma} \label{lem:full-idele-class-action-on-cm}
	Fix an algebraically closed field $k$ of characteristic $0$ and an order $\OO$ of an imaginary quad\-ratic field $K$ embedded in $k$. Then the action of $\op{Pic}(\OO)$ on $Y_\OO$ naturally extends to an action of $\op{Cl}(\OO)(N)$ on $Y_\OO(N)$, where $N$ is either a positive integer or $\infty$.
\end{lemma}
\begin{proof}
	We argue for $N=\infty$ because the claim at finite level follows from the same argument. Given pairs $(\mf a,\tau_{\mf a})\in\op{Cl}(\OO)(\infty)$ and $(E,\tau_E)\in Y_\OO(\infty)$, we need to define some $(\mf a,\tau_{\mf a})\star(E,\tau_E)$. To extend the existing class group action, we need to produce a pair of the form $(\mf a\star E,\tau_\star)$, where $\tau_\star$ is some chosen level structure isomorphism. Well, we simply define $\tau_\star$ as the composite
	\begin{align*}
		\limit(\mf a\star E)[N] &= \limit\op{Hom}_\OO(\mf a,E)[N] \\
		&= \limit\op{Hom}_\OO(\mf a,E[N]) \\
		&= \limit\op{Hom}_{\OO/N\OO}(\mf a/N\mf a,E[N]).
	\end{align*}
	Now, $\tau_{\mf a}$ amounts to a compatible system of isomorphisms $\mf a/N\mf a\to\OO/N\OO$, and $\tau_E$ amounts to a compatible system of isomorphisms $E[N]\to\OO/N\OO$, so we see that they determine an isomorphism
	\begin{align*}
		\limit(\mf a\star E)[N] &= \limit\op{Hom}_{\OO/N\OO}(\mf a/N\mf a,E[N]) \\
		&\stackrel{\tau}\cong\limit\op{Hom}_{\OO/N\OO}(\OO/N\OO,\OO/N\OO) \\
		&= \widehat\OO
	\end{align*}
	on the level of the inverse limit. This provides the action map.

	It remains to check that we have actually defined a group action. Here are our checks.
	\begin{itemize}
		\item We note that changing $(\mf a,\tau_{\mf a})$ or $(E,\tau_E)$ up to isomorphism only adjusts $\op{Hom}(\mf a,E)$ up to isomorphism and then adjusts the level structure isomorphism $\tau_\star$ again up to isomorphism, essentially by construction.
		\item Note that $(\OO,{\id})\star(E,\tau_E)=(E,\tau_E)$ by tracking through the construction. In short, all expressions which look like $\op{Hom}(\mf a,E)$ get compressed into a single $E$, so the last isomorphism marked $\tau$ is simply $\tau_E$.
		\item We check that $(\mf a,\tau)\star((\mf a',\tau')\star(E,\tau_E))=(\mf a\otimes\mf a',\tau\otimes\tau')\star(E,\tau_E)$. We already know that this is true without level structure, so it is enough to check that the level structure morphisms agree. Well, the tensor--hom adjunction can be seen to be natural enough to produce a commutative diagram
		% https://q.uiver.app/#q=WzAsNCxbMCwwLCJcXG9we0hvbX1fXFxPTyhcXG1mIGEsXFxvcHtIb219X1xcT08oXFxtZiBhJyxFKSlbTl0iXSxbMSwwLCJcXG9we0hvbX1fXFxPTyhcXG1mIGEvTixcXG9we0hvbX1fXFxPTyhcXG1mIGEnL04sRVtOXSkpIl0sWzAsMSwiXFxvcHtIb219X1xcT08oXFxtZiBhXFxvdGltZXNcXG1mIGEnLEUpW05dIl0sWzEsMSwiXFxvcHtIb219X1xcT08oKFxcbWYgYVxcb3RpbWVzXFxtZiBhJykvTixFW05dKSJdLFsyLDMsIlxcdGF1Il0sWzAsMSwiXFx0YXUiXSxbMCwyLCIiLDEseyJsZXZlbCI6Miwic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFsxLDMsIiIsMSx7ImxldmVsIjoyLCJzdHlsZSI6eyJoZWFkIjp7Im5hbWUiOiJub25lIn19fV1d&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
		\[\begin{tikzcd}
			{\op{Hom}_\OO(\mf a,\op{Hom}_\OO(\mf a',E))[N]} & {\op{Hom}_\OO(\mf a/N,\op{Hom}_\OO(\mf a'/N,E[N]))} \\
			{\op{Hom}_\OO(\mf a\otimes\mf a',E)[N]} & {\op{Hom}_\OO((\mf a\otimes\mf a')/N,E[N])}
			\arrow["\tau", from=1-1, to=1-2]
			\arrow[equals, from=1-1, to=2-1]
			\arrow[equals, from=1-2, to=2-2]
			\arrow["\tau", from=2-1, to=2-2]
		\end{tikzcd}\]
		from which the claim follows upon taking an inverse limit over $N$ everywhere.
		\qedhere
	\end{itemize}
\end{proof}
\begin{lemma} \label{lem:simply-transitive-cl-action-level}
	Fix an algebraically closed field $k$ of characteristic $0$ and an order $\OO$ of an imaginary quad\-ratic field $K$ embedded in $k$. Then the group $\op{Cl}(\OO)(N)$ acts simply transitively on $Y_\OO(N)$, where $N$ is either a positive integer or $\infty$.
\end{lemma}
\begin{proof}
	We argue for $N=\infty$ because the claim at finite level follows from the same argument. For two pairs $(E,\tau),(E',\tau')\in Y_\OO(\infty)$, we need to show that there is a unique $(\mf a,\tau_{\mf a})\in\op{Cl}(\OO)$ such that $(\mf a,\tau_{\mf a})\star(E,\tau)=(E',\tau')$. By \Cref{prop:simply-transitive-cl-action}, there is a unique $\mf a\in\op{Cl}(\OO)$ such that $\mf a\star E=E'$, so it remains to show that $\tau_{\mf a}$ is unique. Thus, we are looking for $\tau_{\mf a}$ so that
	\[\limit\op{Hom}_\OO(\mf a/N,E[N])\stackrel{\tau'}\cong\widehat\OO\]
	is given by $f\mapsto\tau f\tau_{\mf a}$. Equivalently, we are looking for $\tau_{\mf a}$ so that
	\[\limit\op{Hom}_\OO(\mf a/N,\OO/N\OO)\stackrel{\tau'\circ(\tau\circ-)}\cong\widehat\OO\]
	is given by $f\mapsto f\tau_{\mf a}$. Well, one can certainly choose some compatible system of level structure isomorphisms $\mf a/N\to\OO/N\OO$ (because $\mf a$ is a line bundle, by working one prime at a time), and upon doing this, we see that we are looking for $\tau_{\mf a}\in\widehat\OO^\times$ so that the induced isomorphism
	\[\limit\op{Hom}_\OO(\OO/N\OO,\OO/N\OO)\cong\widehat\OO\]
	is given by $f\mapsto f\tau_{\mf a}$. Now, this $\tau_{\mf a}$ exists and is unique because the left-hand side is simply $\widehat\OO$.
\end{proof}
% \begin{remark}
% 	The previous lemmas also have analogous versions at finite level, which follow immediately from the given proofs.
% \end{remark}
As before, we should add in a Galois action. For example, $\sigma\in\op{Gal}(k/\QQ)$ will act on $Y_\OO(N)$ by
\[\sigma(E,\tau)\coloneqq\left(\sigma(E),\tau\circ\sigma^{-1}\right),\]
where $\tau\circ\sigma^{-1}$ refers to the composite
\[\sigma(E)[N]=\sigma(E[N])\stackrel{\sigma^{-1}}\to E[N]\stackrel\tau\to\OO/N\OO.\]
We won't check that this is actually a group action, though we remark that it can be done directly. By taking the inverse limit, we recover a group action of $\op{Gal}(k/\QQ)$ on $Y_\OO(\infty)$. Similarly, we note that there is a Galois action on $\op{Cl}(\OO)(N)$ by
\[\sigma(\mf a,\tau_{\mf a})\coloneqq\left(\sigma(\mf a),\tau_{\mf a}\circ\sigma^{-1}\right),\]
and one can check that this is a well-defined group actions by doing essentially the same checks; once again, there is an analogous action at infinite level by taking an inverse limit everywhere.
\begin{remark} \label{rem:class-galois-action-commute-level}
	We also remark that $\sigma((\mf a,\tau_{\mf a})\star(E,\tau_E))=\sigma(\mf a,\tau_{\mf a})\star\sigma(E,\tau_E)$. Without the level structures, this follows from \Cref{lem:galois-and-cl-action-commute}, and checking that the level structures agree is a matter of noting that every part of the construction of the action in \Cref{lem:adelic-class-group-level} commutes with applying the automorphism of $\op{Gal}(K/\QQ)$.
\end{remark}
Before continuing, let's say something about how this story fits in with Shimura varieties. Embed $K\subseteq\CC$. Set $\mc H^{\pm}\coloneqq\CC\setminus\RR$, which we note is a Hermitian symmetric domain for $\mathrm{GL}_2$, and it can be described as the family of homomorphisms $\mathrm U(1)\to\mathrm{GL}_2$ (as groups over $\RR$),\footnote{We work with $\mathrm U(1)$ instead of $\mathbb S$ because we are allowed to ignore centers everywhere.} which we note are described by sending $\begin{bsmallmatrix}
	\cos\theta & \sin\theta \\ -\sin\theta & \cos\theta
\end{bsmallmatrix}$ to $i$.\footnote{One could also send it to $-i$; the sign choice here is a little arbitrary.}

Now, the homomorphism belonging to $\tau$ is called a ``special point'' because it arises from a morphism of Shimura varieties. Roughly speaking, the point is that the stabilizer of $\tau$ contains a maximal torus defined over $\QQ$. To be formal, set $T\coloneqq\op{Res}_{\OO/\ZZ}\mathbb G_{m,\OO}$ as usual, and then $T$ is the desired torus, and one finds that we have a morphism of Shimura varieties given by
\[T(\QQ)\setminus T(\AA_{\QQ,f})\to\mathrm{GL}_2(\QQ)\backslash\left(\mathrm{GL}_2(\AA_{\QQ,f})\times\mc H^{\pm}\right)\]
sending $[a]$ to $[(a,\tau)]$, where $\tau$ is defined by satisfying $\OO=\ZZ\oplus\tau\ZZ$. Notably, even though the left-hand side does not depend on the choice of $E$ or even of $\OO$, but the morphism itself does because it needed us to choose a $\tau$ (though the choice of $\tau$ is removed when we mod out by $\mathrm{GL}_2(\QQ)$). Importantly, this right-hand side has a moduli interpretation in terms of elliptic curves with (full) level structure, so \Cref{lem:full-idele-class-action-on-cm} is explaining what is coming out of this map given $a\in K^\times\backslash\AA_{K,f}^\times$.

On the other hand, we see that there is a Galois action on the moduli interpretation $Y(\infty)$ of the right-hand Shimura variety. Roughly speaking, our main theorem of complex multiplication with this added level structure simply says that the Galois action pulled back to the idele class group $K^\times\backslash\AA_{K,f}^\times$ is given by class field theory.
\begin{theorem}[Main with level structure] \label{thm:main-cm-level}
	Fix an algebraically closed field $k$ of characteristic $0$ and an order $\OO$ of an imaginary quad\-ratic field $K$. Define $\chi\colon\op{Gal}(k/K)\to\op{Cl}(\OO)(\infty)$ by
	\[\sigma(E,\tau)=\chi(\sigma)\star (E,\tau)\]
	for $(E,\tau)\in Y_\OO(\infty)$. Then $\chi$, when composed with the isomorphism to $K^\times\backslash\AA_K^\times$ given by \Cref{lem:adelic-class-group-level}, is the inverse of the Artin reciprocity map sending a uniformizer at $\mf p$ to the arithmetic Frobenius element $\mathrm{Frob}_{\mf p}$.
\end{theorem}
\begin{remark} \label{rem:define-chi-level}
	Let's explain why $\chi$ is a well-defined character. Because $\op{Cl}(\OO)(\infty)$ acts simply transitively on $Y_\OO(\infty)$, certainly $\chi(\sigma)$ is uniquely determined by a single $(E,\tau)$. To get all $(E',\tau')\in Y_\OO(\infty)$, use \Cref{lem:simply-transitive-cl-action-level} to write $(E',\tau')=(\mf a,\tau_{\mf a})\star(E,\tau)$ and then apply \Cref{rem:class-galois-action-commute-level}, writing
	\[\sigma((\mf a,\tau_{\mf a})\star(E,\tau))=\sigma(\mf a,\tau_{\mf a})\star\chi(\sigma)\star(E,\tau)=\chi(\sigma)\star((\mf a,\tau_{\mf a})\star(E,\tau)).\]
	Lastly, $\chi$ is a group homomorphism by its uniqueness: note
	\[\chi(\sigma\sigma')=\sigma\sigma'(E,\tau)=\chi(\sigma)\star\chi(\sigma')\star(E,\tau).\]
\end{remark}
\begin{remark}
	For general Shimura varieties, no moduli description may be available, so one cannot ``prove'' the above theorem. Instead, one simply requires that these sorts of special point actions agree with class field theory, and then this is used to defined canonical models.
\end{remark}
\begin{remark}
	Choose $E\in Y_\OO$, which we know is defined over the Hilbert class field $H$ of $\OO$. If we fix a model of $E$ over $H$, then we obtain a Galois action of $\op{Gal}(\ov\QQ/H)$ on the Tate module $T_\ell E$. However, we note that all the elliptic curves in $Y_\OO$ are isogenous, which can be checked over $\CC$: all proper ideals $\mf a$ of $\OO$ are homothetic because the embedding $\mf a\subseteq\OO$ has finite cokernel. Because isogenies of elliptic curves gives rise to an isomorphism of Tate modules, we then would expect the Galois action of $\op{Gal}(\ov\QQ/\QQ)$ on $Y_\OO$ to produce a Galois action of $\op{Gal}(\ov\QQ/\QQ)$ on our chosen $T_\ell E$. However, these isomorphisms are only defined up to automorphisms of $E$, which amount to a choice of unit in $\OO^\times$.
\end{remark}
\begin{remark}
	The main theorem of complex multiplication provides an action of $\op{Gal}(\ov\QQ/\QQ)$ on $Y_\OO(\infty)$, so one may wonder if it will eventually recover the action of $\op{Gal}(\ov\QQ/H)$ on our Tate module. The previous remark basically says that we can only recover this Galois action on the Tate module up to a unit in $\OO^\times$. This will be explained further on the homework.
\end{remark}

\subsection{Proof of the Main Theorem}
In this subsection, we will prove \Cref{thm:main-cm-level}. By ignoring all the level structure, \Cref{thm:main-cm} follows as well. Philosophically, everything we have done so far has been rather formal, more or less amounting to defining and computing some actions.

We now must do something difficult. Roughly speaking, we are interested in comparing an automorphic ``Hecke'' action coming from the adelic quotient $K^\times\backslash\AA_{K,f}^\times$ with a Galois action coming from $\op{Gal}(\ov K/K)$. We take a moment to remark that this is not too different from relating the coefficients of a modular form (which is an automorphic object) to an elliptic curve (which is a motivic object), which is achieved via the Eichler--Shimura congruence relation. In short, the proof of the Eichler--Shimura congruence relation takes a reduction$\pmod p$ and then reduces everything to a statement about isogenies of elliptic curves over finite fields.

Let's proceed with the proof. We proceed in steps.
\begin{enumerate}
	\item We remark that it is enough to check the result at finite level $N$. Indeed, the theorem amounts to checking that the triangle
	% https://q.uiver.app/#q=WzAsMyxbMCwwLCJLXlxcdGltZXNcXGJhY2tzbGFzaFxcQUFfS15cXHRpbWVzIl0sWzEsMCwiXFxvcHtHYWx9KFxcb3YgSy9LKV57XFxtYXRocm17YWJ9fSJdLFswLDEsIlxcb3B7Q2x9KFxcT08pKFxcaW5mdHkpIl0sWzAsMSwiXFxvcHtBcnR9X0siXSxbMiwwXSxbMSwyLCJcXGNoaSIsMl1d&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
	\[\begin{tikzcd}
		{K^\times\backslash\AA_K^\times} & {\op{Gal}(\ov K/K)^{\mathrm{ab}}} \\
		{\op{Cl}(\OO)(\infty)}
		\arrow["{\op{Art}_K}", from=1-1, to=1-2]
		\arrow["\chi"', from=1-2, to=2-1]
		\arrow[from=2-1, to=1-1]
	\end{tikzcd}\]
	commutes, where $\op{Art}_K$ is the global Artin map, and the left map is the isomorphism of \Cref{lem:adelic-class-group-level}. Establishing the result at finite level $N$ amounts to checking that the outer square of the diagram
	% https://q.uiver.app/#q=WzAsNCxbMCwwLCJLXlxcdGltZXNcXGJhY2tzbGFzaFxcQUFfS15cXHRpbWVzIl0sWzEsMCwiXFxvcHtHYWx9KFxcb3YgSy9LKV57XFxtYXRocm17YWJ9fSJdLFswLDEsIlxcb3B7Q2x9KFxcT08pKFxcaW5mdHkpIl0sWzEsMSwiXFxvcHtDbH0oXFxPTykoTikiXSxbMCwxLCJcXG9we0FydH1fSyJdLFsyLDBdLFsyLDMsIiIsMix7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6ImVwaSJ9fX1dLFsxLDIsIlxcY2hpIiwyXSxbMSwzXV0=&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
	\[\begin{tikzcd}
		{K^\times\backslash\AA_K^\times} & {\op{Gal}(\ov K/K)^{\mathrm{ab}}} \\
		{\op{Cl}(\OO)(\infty)} & {\op{Cl}(\OO)(N)}
		\arrow["{\op{Art}_K}", from=1-1, to=1-2]
		\arrow["\chi"', from=1-2, to=2-1]
		\arrow["\chi_N", from=1-2, to=2-2]
		\arrow[from=2-1, to=1-1]
		\arrow[two heads, from=2-1, to=2-2]
	\end{tikzcd}\]
	commutes, where $\chi_N$ is induced by the right triangle. Because some $(\mf a,\tau)\in\op{Cl}(\OO)(\infty)$ is uniquely determined by its reductions to all finite levels (because we could then recover $(\mf a,\tau)$ by taking a suitable inverse limit), this is enough.

	We take a moment to note that $\chi_N$ can be defined by requiring
	\[\sigma(E,\tau)=\chi_N(\sigma)\star(E,\tau)\]
	for $(E,\tau)\in Y_\OO(N)$, which is a well-defined character by \Cref{rem:define-chi-level}. It makes the right triangle commute by construction of $\chi_N$ (and noting that one may simply forget some amount of level structure at any time in the process).

	% \item We show that it is enough to work with certain Frobenius elements. Taking profinite completion of the idele class group, it will be enough to check that the diagram
	% % https://q.uiver.app/#q=WzAsNCxbMCwwLCJLXlxcdGltZXNcXGJhY2tzbGFzaFxcQUFfS15cXHRpbWVzIl0sWzEsMCwiXFxvcHtHYWx9KFxcb3YgSy9LKV57XFxtYXRocm17YWJ9fSJdLFswLDEsIlxcb3B7Q2x9KFxcT08pKFxcaW5mdHkpIl0sWzEsMSwiXFxvcHtDbH0oXFxPTykoTikiXSxbMCwxLCJcXG9we0FydH1fSyJdLFsyLDBdLFsyLDMsIiIsMix7InN0eWxlIjp7ImhlYWQiOnsibmFtZSI6ImVwaSJ9fX1dLFsxLDIsIlxcY2hpIiwyXSxbMSwzXV0=&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
	% \[\begin{tikzcd}
	% 	{\widehat{K^\times\backslash\AA_K^\times}} & {\op{Gal}(\ov K/K)^{\mathrm{ab}}} \\
	% 	{\op{Cl}(\OO)(\infty)} & {\op{Cl}(\OO)(N)}
	% 	\arrow["{\op{Art}_K}", from=1-1, to=1-2]
	% 	\arrow[from=1-2, to=2-2]
	% 	\arrow[from=2-1, to=1-1]
	% 	\arrow[two heads, from=2-1, to=2-2]
	% \end{tikzcd}\]
	% commutes. This diagram has the defect that the left map is not an isomorphism, but now the top map is an isomorphism. The bottom-right group is finite, and the Galois action happens through a finite quotient at finite level, so the right map is continuous, so its (vertical) fibers are open. Thus, it will be enough to check the commutativity on a dense subset of $\op{Gal}(\ov K/K)^{\mathrm{ab}}$ in the image of $\op{Cl}(\OO)(\infty)\cong K^\times\backslash\AA_K^\times$.
	
	% Well, $\op{Art}_K$ sends uniformizers $\varpi_{\mf p}\in\AA_K^\times$ of primes $\mf p$ of $K$ to Frobenius elements $\mathrm{Frob}_{\mf p}\in\op{Gal}(\ov K/K)^{\mathrm{ab}}$, so we may work with Frobenius elements. In fact, it will be enough to work with a density $1$ subset of Frobenius elements, which we will select in the next step.

	\item Because $\op{Cl}(\OO)(N)$ acts simply transitively on $Y_\OO(N)$ (see \Cref{lem:simply-transitive-cl-action-level}), it is enough to fix a pair $(E,\tau)\in Y_\OO(N)$ and check the commutativity of our square
	\[\begin{tikzcd}
		{K^\times\backslash\AA_K^\times} & {\op{Gal}(\ov K/K)^{\mathrm{ab}}} \\
		{\op{Cl}(\OO)(\infty)} & {\op{Cl}(\OO)(N)}
		\arrow["{\op{Art}_K}", from=1-1, to=1-2]
		\arrow["\chi_N", from=1-2, to=2-2]
		\arrow[from=2-1, to=1-1]
		\arrow[two heads, from=2-1, to=2-2]
	\end{tikzcd}\]
	by checking the action of the result in the bottom-right on our chosen $(E,\tau)$. Now, all pairs in $Y_\OO(N)$ are defined over some fixed number field $L$ (namely, one can give each $E$ a model defined over $L$ and further ensure that $E[N]$ is defined over $L$). Note that this makes the Galois action of $\op{Gal}(\ov K/K)$ on $(E,\tau)$ factor through $\op{Gal}(L/K)$.

	We now define a set $S$ of primes $\mf p$ of $K$ which has density $1$, and we will more or less check the commutativity of the above square on the Frobenius elements $\mathrm{Frob}_{\mf p}$ for $\mf p\in S$. This will be enough because each element of $\op{Gal}(L/K)$ takes the form $\mathrm{Frob}_{\mf p}$ for some such prime $\mf p$ by the Chebotarev density theorem.
	\begin{listroman}
		\item We require that each $\mf p\in S$ is totally split over the prime $(p)$ of $\QQ$ and is unramified all the way up in $L$. This cuts out a density-$1$ subset of primes.
		\item We remove from $S$ the primes $\mf p$ for which each $E$ has bad reduction over any prime $\mf P$ of $L$ lying over $(p)=\mf p\cap\ZZ$. This removes only finitely many primes.
		\item We further remove from $S$ any primes $\mf p$ which divide the level $N$ or the conductor $f$ of $\OO$. This again only removes finitely many primes.
		\item Lastly, we remove from $S$ any prime $\mf p$ lying under some prime $\mf P$ of $L$ dividing $j(E)-j(E')$ for any pair of distinct $E,E'\in Y_\OO$. (Note $j(E)$ and $j(E')$ are already integral at $\mf P$ by the good reduction assumption.) This again only removes finitely many primes because $Y_\OO$ is a finite set.
	\end{listroman}
	We remark that (iii) above is only possible because we passed to finite level.

	\item We take a moment to set up some notation. For clarity, for each $\mf p\in S$, we choose a uniformizer $\varpi_{\mf p}\in K^\times\backslash\AA_K^\times$ at $\mf p$, and we will show we can write ``$(\mf p,\tau_{\mf p})$'' for the corresponding element in $\op{Cl}(\OO)(\infty)$. Here, writing $\mf p$ for an element of $\op{Cl}(\OO)$ is slight abuse of notation, but we note that $\mf p\cap\OO$ is in fact a line bundle because $\mf p\nmid f$: localizing at an open subset $U$ containing $f$ (but avoiding $p$), we see $\OO_{K,U}=\OO_U$, so $\mf p$ has its inverse; and over $f$, $\mf p\cap\OO$ localizes to $\OO$.
	
	As such, we will write $\mf p$ for $\mf p\cap\OO$ whenever possible. Additionally, we note $\mf p\in\op{Cl}(\OO)$ corresponds to the class of $\varpi_{\mf p}\in K^\times\backslash\AA_K^\times/T(\widehat\ZZ)$ (where $T=\op{Res}_{\OO/\ZZ}\mathbb G_{m,\OO}$), which can be seen by construction of the map: away from $p$, we see that we have a local trivialization map $\mf p_U=\OO_U$, meaning that the produced idele (following \Cref{lem:adelic-class-group-level}) is given by a uniformizer at $\mf p$.\footnote{One may need to adjust a sign here to ensure that the uniformizer belongs to $\mf p$ and not its inverse.} We denote $\tau_{\mf p}\colon\mf p_p\to\widehat\OO_p$ as the corresponding trivialization to this idele $\varpi_{\mf p}\in K^\times\backslash\AA_K^\times$.

	Tracking around the diagram, we now see that we are interested in showing
	\[(\mf p,{\id})\star(E,\tau)\stackrel?=\chi_N(\mathrm{Frob}_{\mf p})\star(E,\tau)\]
	for each $\mf p\in S$. Here, ${\id}\colon(\mf p\cap\OO)/N(\mf p\cap\OO)\to\OO/N\OO$ is the level structure isomorphism obtained from noting that we may show this after localizing away from $N$ and in particular at $p$ so that $(\mf p\cap\OO)_N=\OO_N$. Anyway, evaluating both sides, we would like to show that
	\[(\op{Hom}_\OO(\mf p,E),\tau)\stackrel?=\left(\mathrm{Frob}_{\mf p}(E),\tau\circ\mathrm{Frob}_{\mf p}^{-1}\right).\]

	\item We are now ready for the main claim, which is more or less a reduction of the desired equality given in the previous step. Fix a prime $\mf P$ of $L$ lying over $\mf p\in S$. For any $(E',\tau')\in Y_\OO(N)$, we denote the reduction modulo $\mf P$ by $(\ov E',\ov\tau')$. Notably, the reduction $E'[N]\to\ov E'[N]$ is an isomorphism because $\mf P\nmid N$.

	Note that the inclusion $\mf p\subseteq\OO$ induces a map $\pi\colon E\to(\mf p\star E)$, which is non-constant and hence an isogeny. We then claim that the reduction
	\[\ov\pi\colon\ov E\to\ov{\mf p\star E}\]
	is isomorphic to the Frobenius morphism $\mathrm{Frob}\colon\ov E\to\ov E^{(p)}$ (as morphisms over $\ov E$). For continuity reasons, let's go ahead and prove the claim.
	
	Any morphism of curves over $\FF_{\mf P}$ can be separated into a purely inseparable part (which must then be an iterated Frobenius) followed by a separable part; this can be seen on the level of the extension of function fields. Because the Frobenius morphism is degree $p$ and purely inseparable (which is visible on the level of the function fields), it will then be enough check that the above morphism has degree $p$ and is purely inseparable, from which the claim follows by using the aforementioned decomposition. Here are our two checks.
	\begin{itemize}
		\item We claim that $\ov\pi$ has degree $p$. Reduction preserves degree (for example, this can be seen on the level of the Tate module because the natural reduction map $T_\ell E\to T_\ell\ov E$ is an isomorphism away from $\mf P$), so it is enough to check that the map $E\to(\mf p\star E)$ has degree $p$. Similarly, degree is preserved by field extension, so we may compute this degree after base-changing to $\CC$, allowing us to write $E(\CC)=\CC/\mf a$ for some proper ideal $\mf a\subseteq\OO$ and so
		\[(\mf p\star E)(\CC)=\CC/\left(\mf a\mf p^{-1}\right)\]
		by \Cref{ex:cl-action-on-cm-over-c}. Tracking through \Cref{ex:cl-action-on-cm-over-c} reveals that the map $\ov\pi\colon E\to(\mf p\star E)$ is given by a choice of isomorphism $\mf p^{-1}\otimes_\OO\CC\to\CC$, which has degree $[\OO:\mf p\cap\OO]$ by a determinant computation. Now, because $\mf p\nmid f$, we see that $[\OO:\mf p\cap\OO]=[\OO_K:\mf p]=p$ (where the first equality is seen by localizing $f$).
		\item We claim that $\ov\pi$ is purely inseparable. It is enough to check that the map vanishes on tangent spaces. Namely, we would like to show that the natural map $\pi^*\Omega_{\ov{\mf p\star E}/\FF_{\mf P}}\to\Omega_{\ov E/\FF_{\mf P}}$ vanishes. Because taking differentials commutes with base-change, it is enough to check that $\pi^*\Omega_{(\mf p\star E)/\CC}\to\Omega_{E/\CC}$ factors through some endomorphism $\alpha\colon\Omega_{E/\CC}\to\Omega_{E/\CC}$ where $\alpha\in\mf p$. Dualizing differentials yields the tangent space, and we see that the computation of the previous step reveals that the morphism on differentials is some map $\CC\to\CC$ factoring through an isomorphism $\mf p^{-1}\otimes_\OO\CC\to\CC$, which indeed factors through the dual of some endomorphism $\alpha\colon\CC\to\CC$ for $\alpha\in\mf p$ (up to homothety).

		Let's give a second, more Lie-theoretic argument. It is enough to check that the induced map $\op{Lie}\ov\pi\colon\op{Lie}\ov E\to\op{Lie}(\ov{\mf p\star E})$ vanishes, for which we choose to understand $\op{Lie}\pi$. The main claim is that
		\[\op{Lie}(\mf p\star E)\stackrel?=\mf p\star\op{Lie}E,\]
		which can be checked by giving $\mf p$ a finite presentation $\OO^m\to\OO^n\to\mf p\to0$ and noting that applying $\op{Hom}_\OO(-,E)$ and taking the kernel commute. Under the above equality, we find that $\op{Lie}\pi$ is then induced by the embedding $\mf p\into\OO$. Because $\mf p\subseteq\mf P$, this map will then vanish$\pmod{\mf P}$ by its construction.
	\end{itemize}

	\item We show the desired equality described at the end of the third step on the level of the elliptic curves. To begin, we claim that $\mf p\star E\cong\mathrm{Frob}_{\mf p}(E)$. The previous step showed that $\overline{\mf p\star E}\cong\ov E^{(p)}$, so we see that
	\[j(\mf p\star E)\equiv j(\mathrm{Frob}_{\mf p}(E))\pmod{\mf P}.\]
	By construction of $S$ (namely, condition (iv)), having this equivalence forces the required isomorphism.
	
	\item We take a moment to note that the isomorphism $\mf p\star E\to\mathrm{Frob}_{\mf p}(E)$ can be chosen to agree with the isomorphism found after the reduction in the previous step. This is slightly tricky because the isomorphism described was constructed abstractly using $j$-invariants.
	
	For brevity, let $\varphi\colon(\mf p\star E)\to\mathrm{Frob}_{\mf p}(E)$ be any chosen isomorphism, and we note that it is well-defined up to an element of $\op{Aut}\mathrm{Frob}_{\mf p}(E)=\op{Aut}(E)=\OO^\times$. As such, we would like for the reduction diagram
	% https://q.uiver.app/#q=WzAsNCxbMCwwLCJcXG1mIHBcXHN0YXIgRSJdLFswLDEsIlxcb3Z7XFxtZiBwXFxzdGFyIEV9Il0sWzEsMCwiXFxtYXRocm17RnJvYn1fe1xcbWYgcH0oRSkiXSxbMSwxLCJcXG92IEVeeyhwKX0iXSxbMCwxXSxbMiwzXSxbMSwzXSxbMCwyLCJcXHZhcnBoaSJdXQ==&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
	\[\begin{tikzcd}
		{\mf p\star E} & {\mathrm{Frob}_{\mf p}(E)} \\
		{\ov{\mf p\star E}} & {\ov E^{(p)}}
		\arrow["\varphi", from=1-1, to=1-2]
		\arrow[from=1-1, to=2-1]
		\arrow[from=1-2, to=2-2]
		\arrow[from=2-1, to=2-2]
	\end{tikzcd}\]
	to commute up to an element of $\OO^\times$; note that it currently commutes up to an element of $\op{Aut}\ov E^{(p)}=\op{Aut}\ov E$ (by the relevant uniqueness of the isomorphism in the bottom row), and $\op{Aut}\ov E$ is potentially bigger than $\op{Aut}E$! (More formally, we would like this diagram to agree after taking torsion.)
	
	The idea will be to restrict from general automorphisms of $\ov E$ to $\OO$-linear ones. As such, we quickly claim that $\varphi$ is $\OO$-linear. Indeed, $\varphi$ must induce a $k$-linear map on the level of the Lie algebras, so conjugation by $\varphi$ is not allowed to induce complex conjugation on $\OO$ because we have embedded $\OO\subseteq K\subseteq k$ (see \Cref{rem:chosen-o-structure-from-field-embedding}).
	
	% Quickly, we note that $\ov\varphi$ certainly reduces to some isomorphism $\ov{\mf p\star E}\to\ov E^{(p)}$. On the other hand, the isomorphism we constructed previously was defined over $E$ and hence $\OO$-linear, so because all such isomorphisms are well-defined up to an element of $\op{Aut}\ov E^{(p)}=\op{Aut}\ov E$ (which is either an order in $K$ or a quaternion algebra over $K$), we see that $\ov\varphi$ must be $\OO$-linear, so $\varphi$ must be $\OO$-linear. (The only alternative is for $\varphi$ to induce complex conjugation on $\OO$, which it would then have to also do in the reduction. Note that complex conjugation on $\OO$ is not an inner automorphism even of the quaternion algebra.)\todo{Wrong.}

	Thus, because $\varphi$ is seen to be $\OO$-linear, we see that the diagram will at worst commute up to an element of $\op{Aut}_\OO\ov E^{(p)}=\op{Aut}_\OO\ov E$. Thus, it remains to show that $\op{Aut}_\OO\ov E=\OO^\times$. To begin, note that $\op{End}_\OO(\ov E)_\QQ=K$: if $\op{End}\ov E\subseteq K$, then there is nothing to say; otherwise, $\op{End}(\ov E)$ is a quaternion algebra with maximal subfield $K$, so the centralizer of $K$ is itself, and we are still done. Thus, we only have to check that $\alpha\in\op{Aut}_\OO(\ov E)$ as an element of $K$ will live in $\OO$. There are two cases for denominators.
	\begin{itemize}
		\item Note that $\alpha$ cannot have any denominators at the primes over $p$: because $p$ is coprime to the conductor, we know $\OO_{p}=\OO_{K,p}$, and $\alpha$ is integral over $\ZZ$ must be in $\OO_{K,p}$.
		\item For $M$ coprime to $p$, we know that $\alpha$ must induce an isomorphism $\ov E[M]\to\ov E[M]$, which after applying a level structure isomorphism means that multiplication by $\alpha$ is an isomorphism $\OO/M\OO\to\OO/M\OO$ of $\OO$-modules. (Note that we have used the fact that $\alpha$ is $\OO$-linear here!) Thus, $\alpha$ cannot have any denominators at any primes above any rational prime dividing $M$.
	\end{itemize}

	\item It remains to check the compatibility of the level structure morphisms. Because $N$-torsion is defined over the reduction, we may as well check that our level structure isomorphisms are equal over $\FF_{\mf P}$. For this, we write down the following large commutative diagram.
	% https://q.uiver.app/#q=WzAsNixbMCwxLCJcXE9PL04iXSxbMSwxLCJcXG92IEVbTl0iXSxbMSwyLCJcXG9we0hvbX1fXFxPTyhcXE9PL04sXFxvdiBFW05dKSJdLFsyLDEsIlxcb3Z7XFxtZiBwXFxzdGFyIEV9W05dIl0sWzIsMiwiXFxvcHtIb219X1xcT08oXFxPTy9OLFxcb3Z7XFxtZiBwXFxzdGFyIEV9W05dKSJdLFsyLDAsIlxcb3YgRV57KHApfVtOXSJdLFsxLDAsIlxcdGF1IiwyXSxbMSwyLCIiLDAseyJsZXZlbCI6Miwic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFsxLDNdLFsxLDVdLFszLDQsIiIsMCx7ImxldmVsIjoyLCJzdHlsZSI6eyJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzIsNF0sWzMsNV1d&macro_url=https%3A%2F%2Fraw.githubusercontent.com%2FdFoiler%2Fnotes%2Fmaster%2Fnir.tex
	\[\begin{tikzcd}
		&& {\ov E^{(p)}[N]} \\
		{\OO/N} & {\ov E[N]} & {\ov{\mf p\star E}[N]} \\
		& {\op{Hom}_\OO(\OO/N,\ov E[N])} & {\op{Hom}_\OO(\OO/N,\ov{\mf p\star E}[N])}
		\arrow[from=2-2, to=1-3]
		\arrow["\tau"', from=2-2, to=2-1]
		\arrow[from=2-2, to=2-3]
		\arrow[equals, from=2-2, to=3-2]
		\arrow[from=2-3, to=1-3]
		\arrow[equals, from=2-3, to=3-3]
		\arrow[from=3-2, to=3-3]
	\end{tikzcd}\]
	Here, the square commutes by definition of the top horizontal map, and the triangle commutes by the previous step. Notably, there is no ambiguity in the vertical isomorphism of the triangle as explained at the end of the previous paragraph.
	
	By definition, the level structure isomorphism $(\mf p\star E)[N]\to\OO/N\OO$ is given by following the bottom of the square and then composing with $\tau$. Additionally, the level structure isomorphism $\ov {\mathrm{Frob}_{\mf p}(E)}[N]\to\OO/N\OO$ is given by following the top of the diagram. However, the commutativity of the diagram implies that these two level structure isomorphisms are compatible with the isomorphism $\mf p\star E\cong\mathrm{Frob}_{\mf p}(E)$, so we are done.
\end{enumerate}
\begin{remark}
	The main claim in step 4 does not require all conditions (i)--(iv) of $S$. The proof only requires (i)--(iii), and (iv) is used later in the last step.
\end{remark}
\begin{remark}
	We remark that one can remove condition (iv) from the proof if we reorganize the argument somewhat, as follows. Extend $L$ to be large enough so that the composite
	\[\op{Gal}(K^{\mathrm{ab}}/K)\stackrel{\op{Art}_K^{-1}}\to \AA_K^\times/K^\times\to Y_\OO(N)\]
	factors through $\op{Gal}(L/K)$. Then we are interested in showing the equality $\chi_N(\sigma)=\op{Art}_K^{-1}(\sigma)$ for all $\sigma\in\op{Gal}(L/K)$, or equivalently $\sigma(E)\cong\op{Art}^{-1}_K(\sigma)\star E$ (with the equipped level structure). To check this last isomorphism, it is enough to check it after reduction for enough $\mf p$ for which $\sigma=\mathrm{Frob}_{\mf p}$ because the difference of the $j$-invariants have only finitely many prime factors.
\end{remark}
% We will prove \Cref{thm:main-cm-level} by working on $Y_\OO(N)$ for each $N\ge1$, from which the statement for $Y_\OO(\infty)$ follows by taking a limit as $N\to\infty$. It is enough to check the equality after an action on some given $(E,\tau)\in Y_\OO(N)$ by \Cref{lem:simply-transitive-cl-action-level}; we will fix a model for $E$ over a fixed number field $L$, which exists by \Cref{prop:cm-defined-over-number-field}. Additionally, we note that it is enough to check that $\chi$ agrees with the inverse Artin reciprocity map for Frobenius elements $\mathrm{Frob}_{\mf p}$ for a density one subset of primes $\mf p$ of $\OO_K$. To lay our cards on the table, we will work with the set $S$ of primes $\mf p$ of $K$ with the following properties.
% \begin{listroman}
% 	\item We may work with primes $\mf p$ of $K$ which lie over primes $(p)\subseteq\ZZ$ which are totally split all the way up in $L$. In particular, $\OO_K/\mf p$
% 	\item We may assume that $E$ has good reduction at all primes of $L$ lying over $(p)=\mf p\cap\QQ$, effectively ruling out finitely many primes. We also rule out primes $p$ that appear in denominators of the $\OO$-action of $E$.
% 	\item We may assume that $\mf p$ is coprime to $N$ and the conductor $f$ of $\OO$, again ruling out finitely many primes.
% \end{listroman}
% For example, these conditions imply that $E[N]$ is unramified at any prime $\mf P$ of $L$ lying over $\mf p$; this follows by the good reduction of (ii). We would like to study the action of a uniformizer $\varpi_{\mf p}$ on $\mf p\star E$.

% We now take a reduction; let $\ov E$ be the reduction. Because $\mf P$ does not divide $N$, there is an isomorphism $E[N]\to\overline E[N]$ of groups; this of course upgrades to an isomorphism of $\OO$-modules, where the $\OO$-action is defined over $\FF_{\mf P}$ by (ii). In fact, this reduction map is even Galois-invariant.\todo{} Now, one can use the embedding $(\mf p\cap\OO)\subseteq\OO$ to produce an isogeny (in the opposite direction) $E\to(\mf p\cap\OO)\star E$. After taking reduction modulo $\mf P$, we produce an isogeny
% \[\ov E\to\ov{(\mf p\cap\OO)\star E},\]
% where the right-hand side can be realized as $\op{Hom}_\OO(\mf p\cap\OO,\ov E)$.

% The main claim is that the reduced isogeny of the previous paragraph is isomorphic to the Frobenius morphism $\ov E\to\ov E^{(p)}$. Quickly, we note that this will complete the proof because it explains that the uniformizer $\varpi_{\mf p}$, which induces the composite
% \[\ov E[N]\to\ov{(\mf p\cap\OO)\star E}[N]\]
% is simply given by Frobenius, which roughly produces the desired claim.

% Lastly, it remains to prove the main claim. It is enough to check that our isogeny is purely inseparable and degree $p$. (Indeed, any morphism of elliptic curves over $\FF_p$ can be factored as some number of Frobenius morphisms followed by a separable morphism; this can be seen on the level of the function fields.) Here are our two checks.
% \begin{itemize}
% 	\item By comparing with $\CC$, we see that the degree of the morphism equals the index $[\OO:\mf p\cap\OO]$, which can be computed as $p$.
% 	\item To check that this is purely inseparable, we may check that the morphism vanishes on the Lie algebras. Well, one can calculate that the map
% 	\[\op{Lie}E\to\op{Lie}((\mf p\cap\OO)\star E)\]
% 	is given at least by multiplication by a uniformizer $\varpi_{\mf p}$, which vanishes after the reduction. For the calculation, one notes that the Lie algebra morphism can be seen as the composite
% 	\[\op{Lie}E=\op{Hom}_\OO(\OO,\op{Lie}E)\to\op{Lie}\op{Hom}_\OO(\mf p,E)\subseteq\op{Hom}_\OO(\mf p,\op{Lie}E).\]
% 	The left inclusion can be seen by writing out some exact sequences with the dual numbers to define the Lie algebra.
% \end{itemize}
% This completes the proof.

\end{document}